@startuml
title SMTP transaction (submission -> relay -> delivery)

skinparam shadowing false

participant "MUA\n(client)" as MUA
participant "Outgoing MSA/MTA\n(smtp.example)" as MTA1
participant "DNS\n(MX)" as DNS
participant "Incoming MTA\n(mx.receiver.tld)" as MTA2
database "Mailbox" as MB

== Submission ==
MUA -> MTA1 : TCP connect :587
MTA1 --> MUA : 220 Service ready
MUA -> MTA1 : EHLO
MTA1 --> MUA : 250 capabilities\n(AUTH, STARTTLS, ...)
MUA -> MTA1 : STARTTLS (optional)
MUA -> MTA1 : AUTH (optional)
MUA -> MTA1 : MAIL FROM:<alice@sender.tld>
MTA1 --> MUA : 250 OK
MUA -> MTA1 : RCPT TO:<bob@receiver.tld>
MTA1 --> MUA : 250 OK
MUA -> MTA1 : DATA
MTA1 --> MUA : 354 End data with <CRLF>.<CRLF>
MUA -> MTA1 : headers + body\n.\n
MTA1 --> MUA : 250 queued

== Relay / delivery ==
MTA1 -> DNS : MX lookup receiver.tld
DNS --> MTA1 : mx.receiver.tld, priority
MTA1 -> MTA2 : TCP connect :25
MTA2 --> MTA1 : 220 Service ready
MTA1 -> MTA2 : MAIL FROM / RCPT TO / DATA
MTA2 --> MTA1 : 250 OK (accepted)
MTA2 -> MB : store in mailbox

@enduml
