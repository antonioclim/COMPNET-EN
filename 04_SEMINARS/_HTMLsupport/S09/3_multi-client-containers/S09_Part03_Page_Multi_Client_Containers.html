<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage 4: Multi-Client Docker FTP Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        /* Network Animations */
        @keyframes pulse-connection {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .connection-line {
            position: absolute;
            height: 2px;
            background: #475569;
            transform-origin: 0 50%;
            z-index: 0;
        }

        .connection-line.active {
            background: #3b82f6;
            box-shadow: 0 0 8px #3b82f6;
        }

        .packet {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 4px; /* Square for TCP segments */
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: white;
            box-shadow: 0 0 10px currentColor;
        }

        /* CRT Effect for Terminals */
        .terminal-window {
            background-color: #000;
            border: 1px solid #334155;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            font-family: 'JetBrains Mono', monospace;
            position: relative;
            overflow: hidden;
        }
        
        .scanline {
            width: 100%;
            height: 100%;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0,0,0,0) 50%, rgba(0,255,0,0.02) 50%), linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
        }

        .container-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .container-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .status-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .file-icon {
            transition: all 0.5s ease-in-out;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-200">

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 h-16 flex items-center justify-between px-6 shadow-lg z-20">
        <div class="flex items-center gap-4">
            <div class="p-2 bg-blue-600/20 rounded-lg border border-blue-500/30">
                <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            </div>
            <div>
                <h1 class="text-lg font-bold text-white tracking-tight">Stage 4: Multi-Client Architecture</h1>
                <p class="text-xs text-slate-400">Docker Compose &bull; Bridge Network &bull; FTP Protocol</p>
            </div>
        </div>
        <div class="flex gap-3">
            <div class="px-3 py-1 bg-slate-900 rounded border border-slate-700 text-xs font-mono text-slate-400 flex items-center">
                <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                System Healthy
            </div>
            <button onclick="location.reload()" class="px-4 py-1.5 text-sm bg-slate-700 hover:bg-slate-600 text-white rounded border border-slate-600 transition-colors shadow-sm">
                Reset Simulation
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar: Learning Guide -->
        <aside class="w-80 bg-slate-900 border-r border-slate-800 flex flex-col z-10 shadow-xl">
            <div class="p-4 border-b border-slate-800 bg-slate-800/50">
                <h2 class="font-bold text-blue-400 text-sm uppercase tracking-wider">Concept Guide</h2>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-6">
                <!-- Step 1 Info -->
                <div id="guide-intro" class="guide-step opacity-100 transition-opacity duration-500">
                    <h3 class="text-sm font-semibold text-white mb-2">1. The Architecture</h3>
                    <p class="text-xs text-slate-400 leading-relaxed mb-2">
                        We have 3 isolated containers defined in <code class="bg-slate-800 px-1 rounded text-blue-300">S09_Part03_Config_Docker_Compose.yml</code> connected via a bridge network <code class="text-orange-300">ftpnet</code>.
                    </p>
                    <ul class="text-xs text-slate-500 space-y-1 ml-2 list-disc">
                        <li><strong>Server:</strong> Hosts files (pyftpdlib).</li>
                        <li><strong>Client 1:</strong> Upload source.</li>
                        <li><strong>Client 2:</strong> Download destination.</li>
                    </ul>
                </div>

                <!-- Dynamic Learning Content -->
                <div id="learning-console" class="hidden space-y-4">
                    <div class="p-3 bg-blue-900/20 border border-blue-800/50 rounded-lg">
                        <div class="text-[10px] font-bold text-blue-400 uppercase mb-1">Current Action</div>
                        <div id="action-text" class="text-sm text-white font-mono">Waiting...</div>
                    </div>

                    <div class="p-3 bg-slate-800 rounded-lg border border-slate-700">
                        <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Protocol Details</div>
                        <div id="protocol-text" class="text-xs text-slate-300">
                            FTP (File Transfer Protocol) uses two channels:
                            <br>1. <strong>Control (2121):</strong> Commands like USER, STOR.
                            <br>2. <strong>Data (Passive):</strong> Actual file content.
                        </div>
                    </div>

                     <div class="p-3 bg-slate-800 rounded-lg border border-slate-700">
                        <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Docker Internal DNS</div>
                        <div class="text-xs text-slate-300">
                            Clients connect to hostname <code class="text-yellow-400">ftp-server</code>. Docker resolves this automatically to the container's internal IP (e.g., 172.18.0.2).
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="p-4 border-t border-slate-800 bg-slate-900">
                <div class="space-y-3">
                    <button id="btn-upload" onclick="startScenario('upload')" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-sm transition-all shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2 group">
                        <span>1. Run Client 1 Upload</span>
                        <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                    <button id="btn-download" onclick="startScenario('download')" disabled class="w-full py-3 bg-slate-800 text-slate-600 rounded-lg font-bold text-sm border border-slate-700 flex items-center justify-center gap-2 cursor-not-allowed">
                        <span>2. Run Client 2 Download</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Canvas -->
        <main class="flex-1 relative bg-[#0B1120] overflow-hidden">
            <!-- Background Grid -->
            <div class="absolute inset-0 opacity-10" style="background-image: linear-gradient(#334155 1px, transparent 1px), linear-gradient(90deg, #334155 1px, transparent 1px); background-size: 40px 40px;"></div>

            <!-- Network Topology Visuals -->
            <div id="network-switch" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-32 h-32 rounded-full border-2 border-dashed border-slate-600 flex items-center justify-center z-0">
                <div class="bg-slate-800 px-3 py-1 rounded text-xs text-slate-400 font-mono">bridge: ftpnet</div>
            </div>

            <!-- Container Grid -->
            <div class="relative z-10 w-full h-full p-10 flex flex-col justify-between max-w-5xl mx-auto">
                
                <!-- Top Row: Server -->
                <div class="flex justify-center">
                    <div id="server-card" class="container-card w-96 bg-slate-800/90 backdrop-blur border border-purple-500/30 rounded-xl overflow-hidden flex flex-col shadow-2xl">
                        <!-- Header -->
                        <div class="bg-slate-900/50 p-3 border-b border-slate-700 flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="status-dot bg-green-500 animate-pulse"></span>
                                <span class="font-bold text-sm text-white">ftp-server</span>
                            </div>
                            <span class="text-[10px] font-mono text-purple-400">172.18.0.2 : 2121</span>
                        </div>
                        
                        <!-- Content -->
                        <div class="p-4 flex flex-col gap-3">
                            <!-- Volume Visualization -->
                            <div class="bg-slate-900/80 rounded border border-slate-700 p-2">
                                <div class="flex justify-between items-center mb-2 border-b border-slate-800 pb-1">
                                    <span class="text-[10px] text-slate-500 uppercase">Volume Mount: ./server-data</span>
                                    <span class="text-[10px] text-slate-500 font-mono">/app/test</span>
                                </div>
                                <div id="server-storage" class="h-16 flex items-center justify-center border border-dashed border-slate-700 rounded bg-slate-900/50 relative overflow-hidden">
                                    <span id="server-empty-msg" class="text-xs text-slate-600 italic">Empty</span>
                                </div>
                            </div>

                            <!-- Terminal -->
                            <div class="terminal-window h-32 rounded text-[10px] p-2 overflow-y-auto">
                                <div class="scanline"></div>
                                <div id="server-log" class="text-purple-300 whitespace-pre-wrap font-mono relative z-20">root@ftp-server:/app# python S09_Part03_Script_Pyftpd_Server.py
FTP Server pyftpdlib started on port 2121...
User: test / 12345, root=./test
</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Row: Clients -->
                <div class="flex justify-between items-end mt-auto gap-8">
                    
                    <!-- Client 1 -->
                    <div id="c1-card" class="container-card flex-1 bg-slate-800/90 backdrop-blur border border-blue-500/30 rounded-xl overflow-hidden flex flex-col shadow-xl">
                        <div class="bg-slate-900/50 p-3 border-b border-slate-700 flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="status-dot bg-green-500"></span>
                                <span class="font-bold text-sm text-white">client1</span>
                            </div>
                            <span class="text-[10px] font-mono text-blue-400">172.18.0.3</span>
                        </div>
                        
                        <div class="p-4 flex flex-col gap-3">
                            <div class="bg-slate-900/80 rounded border border-slate-700 p-2">
                                <div class="text-[10px] text-slate-500 uppercase mb-2 border-b border-slate-800 pb-1">Local Files: ./client1-data</div>
                                <div id="c1-storage" class="h-12 flex items-center gap-2">
                                    <!-- Source File -->
                                    <div id="source-file" class="group relative flex flex-col items-center cursor-help">
                                        <svg class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"></path></svg>
                                        <span class="text-[8px] font-mono text-slate-400 mt-1">from_client1.txt</span>
                                        <div class="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-[9px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap border border-slate-700">Content: "Hello from client1"</div>
                                    </div>
                                </div>
                            </div>

                            <div class="terminal-window h-24 rounded text-[10px] p-2 overflow-y-auto">
                                <div class="scanline"></div>
                                <div id="c1-log" class="text-blue-300 whitespace-pre-wrap font-mono relative z-20"># waiting for command...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Client 2 -->
                    <div id="c2-card" class="container-card flex-1 bg-slate-800/90 backdrop-blur border border-teal-500/30 rounded-xl overflow-hidden flex flex-col shadow-xl">
                        <div class="bg-slate-900/50 p-3 border-b border-slate-700 flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="status-dot bg-green-500"></span>
                                <span class="font-bold text-sm text-white">client2</span>
                            </div>
                            <span class="text-[10px] font-mono text-teal-400">172.18.0.4</span>
                        </div>
                        
                        <div class="p-4 flex flex-col gap-3">
                            <div class="bg-slate-900/80 rounded border border-slate-700 p-2">
                                <div class="text-[10px] text-slate-500 uppercase mb-2 border-b border-slate-800 pb-1">Local Files: ./client2-data</div>
                                <div id="c2-storage" class="h-12 flex items-center gap-2">
                                    <span id="c2-empty-msg" class="text-xs text-slate-600 italic ml-2">Empty</span>
                                </div>
                            </div>

                            <div class="terminal-window h-24 rounded text-[10px] p-2 overflow-y-auto">
                                <div class="scanline"></div>
                                <div id="c2-log" class="text-teal-300 whitespace-pre-wrap font-mono relative z-20"># waiting for command...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Animation Layer -->
            <div id="animation-layer" class="absolute inset-0 pointer-events-none z-50"></div>
        </main>
    </div>

    <script>
        // --- Configuration & Constants ---
        const DELAY = {
            STEP: 800,
            PACKET: 600
        };
        const FILENAME = "from_client1.txt";

        // --- DOM Elements ---
        const logs = {
            server: document.getElementById('server-log'),
            c1: document.getElementById('c1-log'),
            c2: document.getElementById('c2-log')
        };
        
        const ui = {
            learningPanel: document.getElementById('learning-console'),
            actionText: document.getElementById('action-text'),
            protocolText: document.getElementById('protocol-text'),
            btnUpload: document.getElementById('btn-upload'),
            btnDownload: document.getElementById('btn-download'),
            serverStorage: document.getElementById('server-storage'),
            c2Storage: document.getElementById('c2-storage')
        };

        let uploadComplete = false;

        // --- Utils ---
        const sleep = ms => new Promise(r => setTimeout(r, ms));

        function log(node, text, type = 'info') {
            const el = logs[node];
            const div = document.createElement('div');
            div.textContent = text;
            if (type === 'cmd') div.className = 'text-white font-bold';
            if (type === 'error') div.className = 'text-red-400';
            if (type === 'success') div.className = 'text-green-400';
            el.appendChild(div);
            el.scrollTop = el.scrollHeight;
        }

        function updateGuide(action, protocol) {
            ui.learningPanel.classList.remove('hidden');
            document.getElementById('guide-intro').classList.add('opacity-50');
            ui.actionText.textContent = action;
            if(protocol) ui.protocolText.innerHTML = protocol;
        }

        function getPos(id) {
            const el = document.getElementById(id);
            const rect = el.getBoundingClientRect();
            return {
                x: rect.left + rect.width / 2,
                y: rect.top + rect.height / 2
            };
        }

        // --- Animations ---

        async function sendPacket(fromId, toId, type = 'TCP', color = '#60a5fa') {
            const start = getPos(fromId);
            const end = getPos(toId);
            
            const pkt = document.createElement('div');
            pkt.className = 'packet';
            pkt.textContent = type;
            pkt.style.backgroundColor = color;
            pkt.style.left = start.x + 'px';
            pkt.style.top = start.y + 'px';
            
            // Adjust label size for long text
            if(type.length > 4) pkt.style.width = 'auto';
            if(type.length > 4) pkt.style.padding = '0 4px';

            document.getElementById('animation-layer').appendChild(pkt);

            const anim = pkt.animate([
                { left: start.x + 'px', top: start.y + 'px' },
                { left: end.x + 'px', top: end.y + 'px' }
            ], {
                duration: DELAY.PACKET,
                easing: 'cubic-bezier(0.4, 0, 0.2, 1)'
            });

            await anim.finished;
            pkt.remove();
        }

        async function animateFileTransfer(fromStorageId, toStorageId) {
            // Create flying file
            const startEl = document.getElementById(fromStorageId).querySelector('svg') || document.querySelector(`#${fromStorageId} svg`);
            const endContainer = document.getElementById(toStorageId);
            
            const rect = startEl.getBoundingClientRect();
            const endRect = endContainer.getBoundingClientRect();

            const flyer = startEl.cloneNode(true);
            flyer.style.position = 'fixed';
            flyer.style.left = rect.left + 'px';
            flyer.style.top = rect.top + 'px';
            flyer.style.zIndex = 100;
            flyer.classList.remove('text-yellow-500');
            flyer.classList.add('text-green-400'); // Green in transit
            
            document.body.appendChild(flyer);

            const anim = flyer.animate([
                { left: rect.left + 'px', top: rect.top + 'px', transform: 'scale(1)' },
                { left: (endRect.left + 20) + 'px', top: (endRect.top + 10) + 'px', transform: 'scale(0.8)' }
            ], {
                duration: 1200,
                easing: 'ease-in-out'
            });

            await anim.finished;
            flyer.remove();

            // Create persistent file at destination
            if (toStorageId === 'server-storage') {
                document.getElementById('server-empty-msg').style.display = 'none';
                const fileHTML = `
                    <div class="flex flex-col items-center animate-bounce">
                        <svg class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"></path></svg>
                        <span class="text-[8px] font-mono text-slate-400 mt-1">${FILENAME}</span>
                    </div>`;
                ui.serverStorage.insertAdjacentHTML('beforeend', fileHTML);
            } else if (toStorageId === 'c2-storage') {
                document.getElementById('c2-empty-msg').style.display = 'none';
                const fileHTML = `
                    <div class="flex flex-col items-center">
                        <svg class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"></path></svg>
                        <span class="text-[8px] font-mono text-slate-400 mt-1">${FILENAME}</span>
                    </div>`;
                ui.c2Storage.insertAdjacentHTML('beforeend', fileHTML);
            }
        }

        // --- Logic ---

        async function startScenario(type) {
            if (type === 'upload') {
                if (ui.btnUpload.disabled) return;
                ui.btnUpload.disabled = true;
                ui.btnUpload.classList.add('opacity-50');
                await runUploadScenario();
            } else if (type === 'download') {
                if (!uploadComplete || ui.btnDownload.disabled) return;
                ui.btnDownload.disabled = true;
                await runDownloadScenario();
            }
        }

        async function runUploadScenario() {
            // 1. Init
            updateGuide("Initializing Upload Script", "The Python script starts inside the container.");
            log('c1', `root@client1:/app# python3 S09_Part03_Script_Pyftpd_Multi_Client.py upload ${FILENAME}`, 'cmd');
            await sleep(DELAY.STEP);

            // 2. DNS & TCP Handshake
            updateGuide("Connection Establishment", "Client connects to 'ftp-server' on port 2121. <br>TCP 3-Way Handshake.");
            log('c1', `[CLIENT] Connecting to FTP ftp-server:2121 ...`);
            
            await sendPacket('c1-card', 'server-card', 'SYN', '#93c5fd');
            await sendPacket('server-card', 'c1-card', 'SYN-ACK', '#c084fc');
            await sendPacket('c1-card', 'server-card', 'ACK', '#93c5fd');
            
            log('server', `[I 172.18.0.3] Connected.`);
            await sleep(DELAY.STEP);

            // 3. Auth
            updateGuide("Authentication", "Sending USER 'test' and PASS '12345'.");
            await sendPacket('c1-card', 'server-card', 'USER', '#93c5fd');
            log('server', `[I 172.18.0.3] USER 'test' logged in.`);
            log('c1', `[CLIENT] Login successful.`, 'success');
            await sleep(DELAY.STEP);

            // 4. Upload (STOR)
            updateGuide("File Transfer (STOR)", "STOR command creates a Passive Data Channel. File moves from Client to Server Volume.");
            log('c1', `[CLIENT] Uploading file ${FILENAME} to server...`);
            
            await sendPacket('c1-card', 'server-card', 'STOR', '#f59e0b'); // Command packet
            
            // Data Transfer Animation
            await animateFileTransfer('source-file', 'server-storage');
            
            log('server', `[I 172.18.0.3] STOR /test/${FILENAME} completed=1 bytes=18.`);
            log('c1', `[CLIENT] Upload complete.`, 'success');
            await sleep(DELAY.STEP);

            // 5. Verification
            updateGuide("Verification", "Listing files (LIST command) to confirm upload.");
            log('c1', `[CLIENT] Files on server after upload:`);
            await sendPacket('c1-card', 'server-card', 'LIST', '#93c5fd');
            log('c1', `-rw-r--r--   1 test     group          18 Nov 02 10:00 ${FILENAME}`);
            
            // 6. Close
            await sendPacket('c1-card', 'server-card', 'QUIT', '#ef4444');
            log('c1', `[CLIENT] Disconnected.`);
            
            uploadComplete = true;
            ui.btnUpload.innerHTML = `<span>Upload Complete</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            
            ui.btnDownload.disabled = false;
            ui.btnDownload.classList.remove('bg-slate-800', 'text-slate-600', 'cursor-not-allowed');
            ui.btnDownload.classList.add('bg-teal-600', 'hover:bg-teal-500', 'text-white', 'shadow-lg');
            
            updateGuide("Ready for Download", "File is now in the server volume. Client 2 can access it.");
        }

        async function runDownloadScenario() {
            // 1. Init
            updateGuide("Initializing Download Script", "Client 2 starts execution.");
            log('c2', `root@client2:/app# python3 S09_Part03_Script_Pyftpd_Multi_Client.py download ${FILENAME}`, 'cmd');
            await sleep(DELAY.STEP);

            // 2. Connect
            updateGuide("Connection Establishment", "Client 2 connects to Server (172.18.0.2).");
            log('c2', `[CLIENT] Connecting to FTP ftp-server:2121 ...`);
            
            await sendPacket('c2-card', 'server-card', 'SYN', '#2dd4bf');
            await sendPacket('server-card', 'c2-card', 'ACK', '#c084fc');
            
            log('server', `[I 172.18.0.4] Connected.`);
            await sleep(DELAY.STEP);

            // 3. Auth
            updateGuide("Authentication", "Same credentials used (shared server).");
            await sendPacket('c2-card', 'server-card', 'USER', '#2dd4bf');
            log('server', `[I 172.18.0.4] USER 'test' logged in.`);
            log('c2', `[CLIENT] Login successful.`, 'success');
            await sleep(DELAY.STEP);

            // 4. Download (RETR)
            updateGuide("File Transfer (RETR)", "RETR command retrieves the file. Moves from Server Volume to Client 2 Volume.");
            log('c2', `[CLIENT] Downloading file ${FILENAME} from server...`);
            
            await sendPacket('c2-card', 'server-card', 'RETR', '#f59e0b');
            
            // Data Transfer Animation (Server -> C2)
            await animateFileTransfer('server-storage', 'c2-storage');
            
            log('server', `[I 172.18.0.4] RETR /test/${FILENAME} completed=1 bytes=18.`);
            log('c2', `[CLIENT] Download complete.`, 'success');
            await sleep(DELAY.STEP);

            // 5. Read Content
            updateGuide("Verification", "Reading file content locally.");
            log('c2', `root@client2:/app# cat client-data/${FILENAME}`, 'cmd');
            log('c2', `Hello from client1`);

            // 6. Close
            await sendPacket('c2-card', 'server-card', 'QUIT', '#ef4444');
            log('c2', `[CLIENT] Disconnected.`);

            ui.btnDownload.innerHTML = `<span>Download Complete</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            ui.btnDownload.classList.add('opacity-50');
            
            updateGuide("Simulation Finished", "Success! The file traveled from Client 1 -> Server -> Client 2.");
        }
    </script>
</body>
</html>