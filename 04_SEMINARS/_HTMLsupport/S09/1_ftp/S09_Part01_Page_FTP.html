<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTP Protocol Visualiser: Active vs Passive</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --panel-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-yellow: #eab308;
            --control-line: #60a5fa;
            --data-line: #facc15;
            --border-radius: 8px;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { margin-bottom: 5px; font-weight: 600; letter-spacing: -0.5px; }
        .subtitle { color: var(--text-secondary); margin-bottom: 30px; font-size: 0.9rem; }

        /* Main Grid Layout */
        .container {
            display: grid;
            grid-template-columns: 300px 400px 300px;
            gap: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        /* Entity Boxes (Client/Server) */
        .entity {
            background-color: var(--panel-bg);
            border: 1px solid #334155;
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 450px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .entity-header {
            font-weight: bold;
            border-bottom: 1px solid #334155;
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .port-indicator {
            font-family: monospace;
            font-size: 0.8rem;
            background: #0f172a;
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--text-secondary);
        }

        .port-indicator.active { color: var(--accent-green); border: 1px solid var(--accent-green); }

        /* File System View */
        .file-system {
            flex-grow: 1;
            background: #0f172a;
            border-radius: 4px;
            padding: 10px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .file {
            display: flex;
            justify-content: space-between;
            padding: 4px;
            border-bottom: 1px solid #1e293b;
            cursor: default;
        }
        .file:hover { background: #1e293b; }

        /* Network / Middle Stage */
        .network-stage {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Connection Lines */
        .connection-line {
            position: absolute;
            height: 4px;
            width: 80%;
            background: #334155;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .line-label {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--bg-color);
            padding: 0 5px;
        }

        #control-channel { top: 35%; background: #334155; }
        #control-channel.connected { background: var(--control-line); box-shadow: 0 0 10px var(--control-line); }
        
        #data-channel { top: 65%; border-top: 2px dashed #475569; background: transparent; height: 0; }
        #data-channel.connected { border-top: 2px dashed var(--data-channel-active); border-color: var(--data-line); }

        /* Packets */
        .packet {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            top: -4px;
            display: none;
        }
        
        .packet-control { background-color: #fff; box-shadow: 0 0 5px #fff; }
        .packet-data { width: 20px; height: 24px; border-radius: 2px; background: var(--text-primary); display: flex; align-items: center; justify-content: center; font-size: 10px; color: #000; top: -12px;}

        /* Controls Panel */
        .controls {
            background-color: var(--panel-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 1000px;
            display: flex;
            gap: 20px;
            align-items: center;
            border: 1px solid #334155;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label { font-size: 0.8rem; color: var(--text-secondary); font-weight: 600; }

        select, button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #475569;
            background: #0f172a;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        button:hover { background: #334155; border-color: var(--accent-blue); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        button.primary { background: var(--accent-blue); border-color: var(--accent-blue); }
        button.primary:hover { background: #2563eb; }

        /* Logs */
        .log-panel {
            width: 100%;
            max-width: 1000px;
            background: #000;
            border-radius: var(--border-radius);
            height: 200px;
            margin-top: 20px;
            padding: 10px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            border: 1px solid #334155;
        }

        .log-entry { margin-bottom: 4px; }
        .log-client { color: #60a5fa; } /* Blue */
        .log-server { color: #fbbf24; } /* Yellow */
        .log-error { color: #ef4444; }
        .log-info { color: #94a3b8; font-style: italic; }

        /* Theory Tooltip Box */
        .theory-box {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid var(--accent-blue);
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            border-radius: 0 4px 4px 0;
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* Animations */
        @keyframes flowLeftRight {
            0% { left: 0%; opacity: 1; }
            100% { left: 100%; opacity: 1; }
        }
        @keyframes flowRightLeft {
            0% { left: 100%; opacity: 1; }
            100% { left: 0%; opacity: 1; }
        }

    </style>
</head>
<body>

    <h1>FTP Protocol Simulator</h1>
    <div class="subtitle">Based on Seminar 9: <code>pyftpdlib</code>, Control vs Data Channels, Active vs Passive Mode</div>

    <div class="container">
        <!-- Client -->
        <div class="entity">
            <div class="entity-header">
                <span>Client (ftplib)</span>
                <span id="client-status" class="port-indicator">Disconnected</span>
            </div>
            <div class="file-system" id="client-fs">
                <!-- Populated by JS -->
            </div>
            <div style="margin-top: auto; padding-top:10px; font-size: 0.8rem; color: #64748b;">
                <strong>Local Ports:</strong><br>
                Ephemeral: <span id="client-ephemeral">---</span><br>
                Data Listener: <span id="client-listener">---</span>
            </div>
        </div>

        <!-- Network / Channels -->
        <div class="network-stage">
            
            <!-- Control Channel -->
            <div id="control-channel" class="connection-line">
                <span class="line-label">Control Channel (Port 2121)</span>
                <div id="control-packet" class="packet packet-control"></div>
            </div>

            <!-- Data Channel -->
            <div id="data-channel" class="connection-line">
                <span class="line-label">Data Channel (Dynamic)</span>
                <div id="data-packet" class="packet packet-data">ðŸ“„</div>
            </div>

            <div id="theory-display" class="theory-box">
                Select a command to see how the protocol works.
            </div>

        </div>

        <!-- Server -->
        <div class="entity">
            <div class="entity-header">
                <span>Server (pyftpdlib)</span>
                <span class="port-indicator active">Listens: 2121</span>
            </div>
            <div class="file-system" id="server-fs">
                 <!-- Populated by JS -->
            </div>
            <div style="margin-top: auto; padding-top:10px; font-size: 0.8rem; color: #64748b;">
                <strong>Server Config:</strong><br>
                User: <span id="server-user">---</span><br>
                Data Port: <span id="server-data-port">---</span>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <div class="control-group">
            <label>Connection Mode</label>
            <select id="mode-select">
                <option value="PASV">Passive (Default)</option>
                <option value="PORT">Active (Legacy)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Authentication</label>
            <select id="auth-select">
                <option value="anonymous">Anonymous</option>
                <option value="test">User: test / 12345</option>
            </select>
        </div>

        <div style="width: 1px; background: #334155; height: 40px; margin: 0 10px;"></div>

        <button id="btn-connect" class="primary" onclick="cmdConnect()">1. Connect & Login</button>
        <button id="btn-list" onclick="cmdList()" disabled>2. LIST Files</button>
        <button id="btn-retr" onclick="cmdRetr()" disabled>3. RETR (Download)</button>
        <button id="btn-stor" onclick="cmdStor()" disabled>4. STOR (Upload)</button>
        <button id="btn-reset" style="margin-left: auto; border-color:#ef4444; color:#ef4444;" onclick="resetSim()">Reset</button>
    </div>

    <!-- Logger -->
    <div class="log-panel" id="log-console">
        <div class="log-entry log-info"># Ready to simulate pyftpdlib on port 2121.</div>
    </div>

    <script>
        // --- State Management ---
        const state = {
            connected: false,
            authenticated: false,
            mode: 'PASV', // PASV or PORT
            currentUser: null,
            serverFiles: ['welcome.msg', 'notes.txt', 'image.jpg'],
            clientFiles: ['homework.py', 'todo_list.txt'],
            serverDataPort: null,
            clientDataPort: null
        };

        // --- DOM Elements ---
        const ui = {
            log: document.getElementById('log-console'),
            controlLine: document.getElementById('control-channel'),
            dataLine: document.getElementById('data-channel'),
            controlPacket: document.getElementById('control-packet'),
            dataPacket: document.getElementById('data-packet'),
            clientFs: document.getElementById('client-fs'),
            serverFs: document.getElementById('server-fs'),
            theory: document.getElementById('theory-display'),
            serverUser: document.getElementById('server-user'),
            serverDataPort: document.getElementById('server-data-port'),
            clientEphemeral: document.getElementById('client-ephemeral'),
            clientListener: document.getElementById('client-listener'),
            clientStatus: document.getElementById('client-status')
        };

        const buttons = {
            connect: document.getElementById('btn-connect'),
            list: document.getElementById('btn-list'),
            retr: document.getElementById('btn-retr'),
            stor: document.getElementById('btn-stor')
        };

        // --- Initialization ---
        function renderFiles() {
            ui.clientFs.innerHTML = state.clientFiles.map(f => `<div class="file">ðŸ“„ ${f}</div>`).join('');
            ui.serverFs.innerHTML = state.serverFiles.map(f => `<div class="file">ðŸ“„ ${f}</div>`).join('');
        }
        renderFiles();

        // --- Logging & Animation Utilities ---
        
        function log(msg, type = 'info') {
            const el = document.createElement('div');
            el.className = `log-entry log-${type}`;
            el.innerText = msg;
            ui.log.appendChild(el);
            ui.log.scrollTop = ui.log.scrollHeight;
        }

        function setTheory(text) {
            ui.theory.style.opacity = '0';
            setTimeout(() => {
                ui.theory.innerHTML = text;
                ui.theory.style.opacity = '1';
            }, 300);
        }

        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        async function animateControl(direction = 'CtoS', text = '') {
            ui.controlPacket.style.display = 'block';
            ui.controlPacket.style.animation = 'none'; // reset
            ui.controlPacket.offsetHeight; // trigger reflow
            
            const duration = 800;
            ui.controlPacket.style.animation = direction === 'CtoS' 
                ? `flowLeftRight ${duration}ms ease-in-out forwards` 
                : `flowRightLeft ${duration}ms ease-in-out forwards`;

            await sleep(duration / 2); // Log halfway through
            if(text) log(text, direction === 'CtoS' ? 'client' : 'server');
            await sleep(duration / 2);
            ui.controlPacket.style.display = 'none';
        }

        async function animateData(direction = 'CtoS') {
            ui.dataPacket.style.display = 'flex';
            ui.dataPacket.style.animation = 'none';
            ui.dataPacket.offsetHeight;
            
            const duration = 1500;
            ui.dataPacket.style.animation = direction === 'CtoS' 
                ? `flowLeftRight ${duration}ms linear forwards` 
                : `flowRightLeft ${duration}ms linear forwards`;

            await sleep(duration);
            ui.dataPacket.style.display = 'none';
        }

        // --- FTP Logic Simulation ---

        async function cmdConnect() {
            buttons.connect.disabled = true;
            state.mode = document.getElementById('mode-select').value;
            const user = document.getElementById('auth-select').value;
            const pass = user === 'test' ? '12345' : 'guest@example.com';

            ui.clientStatus.innerText = "Connecting...";
            ui.clientStatus.style.color = "#eab308"; // yellow
            
            setTheory("<strong>Step 1: TCP Handshake & Greeting</strong><br>The client initiates a TCP connection to Server Port 2121 (Control Channel). The server responds with a 220 Greeting.");

            // Initial Handshake simulation
            ui.controlLine.classList.add('connected');
            await sleep(500);
            
            await animateControl('StoC', "220 pyftpdlib 1.5.6 ready.");
            
            ui.clientStatus.innerText = "Connected";
            ui.clientStatus.style.color = "#22c55e"; // green
            ui.clientStatus.classList.add('active');

            // Authentication
            setTheory("<strong>Step 2: Authentication</strong><br>Commands circulate over the Control Channel. USER sends the username, PASS sends the password (cleartext in standard FTP!).");
            
            await animateControl('CtoS', `USER ${user}`);
            await animateControl('StoC', "331 Username ok, send password.");
            
            await animateControl('CtoS', `PASS ${'*'.repeat(pass.length)}`);
            await animateControl('StoC', "230 Login successful.");

            state.connected = true;
            state.currentUser = user;
            ui.serverUser.innerText = user;
            
            // Enable next buttons
            buttons.list.disabled = false;
            buttons.retr.disabled = false;
            buttons.stor.disabled = false;

            log(`> Logged in as ${user}. Ready for commands.`, 'info');
        }

        async function setupDataConnection() {
            // Determines who opens the port based on Mode (Active/Passive)
            if (state.mode === 'PASV') {
                setTheory("<strong>Passive Mode (PASV) - NAT Friendly</strong><br>1. Client asks for PASV.<br>2. Server opens a random port (e.g. 45000) and tells Client.<br>3. Client connects to Server.");
                
                await animateControl('CtoS', "PASV");
                
                // Server opens port
                const randomPort = Math.floor(Math.random() * 10000) + 40000;
                ui.serverDataPort.innerText = randomPort;
                state.serverDataPort = randomPort;

                await animateControl('StoC', `227 Entering Passive Mode (127,0,0,1,${Math.floor(randomPort/256)},${randomPort%256}).`);
                
                log(`> Client connecting to Server Data Port ${randomPort}...`, 'info');
                ui.dataLine.classList.add('connected');
                await sleep(500);

            } else {
                setTheory("<strong>Active Mode (PORT) - Firewall Nightmare</strong><br>1. Client opens a random port and listens.<br>2. Client sends PORT command (IP + Port) to Server.<br>3. Server connects to Client.");
                
                // Client opens port
                const randomPort = Math.floor(Math.random() * 10000) + 50000;
                ui.clientListener.innerText = randomPort;
                state.clientDataPort = randomPort;

                await animateControl('CtoS', `PORT 127,0,0,1,${Math.floor(randomPort/256)},${randomPort%256}`);
                await animateControl('StoC', "200 PORT command successful.");
                
                log(`> Server connecting to Client Data Port ${randomPort}...`, 'info');
                ui.dataLine.classList.add('connected');
                await sleep(500);
            }
        }

        async function teardownDataConnection() {
            ui.dataLine.classList.remove('connected');
            ui.serverDataPort.innerText = "---";
            ui.clientListener.innerText = "---";
            log("> Data channel closed.", 'info');
        }

        async function cmdList() {
            if(!state.connected) return;
            disableButtons(true);

            await setupDataConnection();
            
            setTheory("<strong>LIST Command</strong><br>1. Control Channel negotiates.<br>2. Data Channel opens.<br>3. The actual directory listing text flows through the Data Channel (yellow line).");
            
            await animateControl('CtoS', "LIST");
            await animateControl('StoC', "150 Here comes the directory listing.");
            
            // Data Transfer
            log("DATA CHANNEL: [Transferring directory listing...]", 'info');
            await animateData('StoC'); // Server sends list to client

            await animateControl('StoC', "226 Directory send OK.");
            
            await teardownDataConnection();
            disableButtons(false);
        }

        async function cmdRetr() {
            if(!state.connected) return;
            disableButtons(true);

            const fileToGet = state.serverFiles[0]; // Just take first file for demo

            await setupDataConnection();

            setTheory(`<strong>RETR (Download)</strong><br>Downloading '${fileToGet}'. Note that commands go on Control (Blue), but the file contents travel on Data (Yellow).`);

            await animateControl('CtoS', `RETR ${fileToGet}`);
            
            if(state.serverFiles.includes(fileToGet)) {
                await animateControl('StoC', `150 Opening BINARY mode data connection for ${fileToGet}`);
                
                log(`DATA CHANNEL: [Binary bits of ${fileToGet}]`, 'info');
                await animateData('StoC');

                // Logic: Add to client
                if(!state.clientFiles.includes(fileToGet)) {
                    state.clientFiles.push(fileToGet);
                    renderFiles();
                    log(`> File ${fileToGet} saved to local disk.`, 'info');
                }

                await animateControl('StoC', "226 Transfer complete.");
            } else {
                await animateControl('StoC', "550 Failed to open file.");
            }

            await teardownDataConnection();
            disableButtons(false);
        }

        async function cmdStor() {
            if(!state.connected) return;
            disableButtons(true);

            // Mock file upload
            const fileToPut = "new_upload.py";

            if (state.currentUser === 'anonymous') {
                setTheory("<strong>Permission Denied</strong><br>Anonymous users usually only have Read (r) permissions. Write (w) is disabled.");
                await animateControl('CtoS', `STOR ${fileToPut}`);
                await animateControl('StoC', "550 Permission denied.");
            } else {
                await setupDataConnection();
                setTheory(`<strong>STOR (Upload)</strong><br>Uploading '${fileToPut}'. Client sends data to Server over the Data Channel.`);

                await animateControl('CtoS', `STOR ${fileToPut}`);
                await animateControl('StoC', "150 Ok to send data.");

                log(`DATA CHANNEL: [Binary bits of ${fileToPut}]`, 'info');
                await animateData('CtoS');

                if(!state.serverFiles.includes(fileToPut)) {
                    state.serverFiles.push(fileToPut);
                    renderFiles();
                }

                await animateControl('StoC', "226 Transfer complete.");
                await teardownDataConnection();
            }

            disableButtons(false);
        }

        function disableButtons(bool) {
            buttons.list.disabled = bool;
            buttons.retr.disabled = bool;
            buttons.stor.disabled = bool;
            buttons.connect.disabled = bool; // Keep connect disabled if connected
        }

        function resetSim() {
            location.reload();
        }

    </script>
</body>
</html>