<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pseudo-FTP Simulator</title>
    <style>
        :root {
            --bg: #1e1e2e;
            --panel: #262636;
            --text: #cdd6f4;
            --blue: #89b4fa;   /* Control */
            --yellow: #f9e2af; /* Data */
            --green: #a6e3a1;  /* Listen */
            --red: #f38ba8;    /* Connection Direction */
            --border: #45475a;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin: 0;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll, focus on app */
        }

        /* Top Status Bar */
        #main-status {
            background: #11111b;
            color: var(--yellow);
            width: 100%;
            text-align: center;
            padding: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 2px solid var(--blue);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 100;
        }

        /* Grid Layout */
        .grid-container {
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: 20px;
            width: 95%;
            max-width: 1400px;
            height: 60vh; /* Fixed height area for sim */
            margin-top: 20px;
            position: relative;
        }

        /* Panels */
        .panel {
            background: var(--panel);
            border: 3px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s;
        }

        .panel-header {
            font-size: 1.1rem;
            font-weight: bold;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Radar Effect for Listen */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(166, 227, 161, 0.4); border-color: var(--green); }
            70% { box-shadow: 0 0 0 20px rgba(166, 227, 161, 0); border-color: var(--green); }
            100% { box-shadow: 0 0 0 0 rgba(166, 227, 161, 0); border-color: var(--green); }
        }

        .listening {
            animation: pulse-green 1.5s infinite;
        }

        /* File List */
        .file-list {
            flex: 1;
            background: #11111b;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow-y: auto;
            padding: 5px;
        }
        .file {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            transition: background 0.2s;
        }
        .file:hover { background: #313244; }
        .file.selected { background: #45475a; border-left: 4px solid var(--blue); }

        /* Central Zone (Network) */
        .network-zone {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Channels */
        .channel-label {
            position: absolute;
            font-size: 0.8rem;
            background: var(--bg);
            padding: 2px 8px;
            color: #aaa;
            z-index: 5;
        }

        /* Control Line (Blue) */
        .line-control {
            width: 100%;
            height: 4px;
            background: #45475a;
            position: absolute;
            top: 25%;
        }
        .line-control.connected { background: var(--blue); box-shadow: 0 0 10px var(--blue); }

        /* Data Line (Yellow) */
        .line-data {
            width: 100%;
            height: 8px;
            border-top: 4px dashed #45475a;
            position: absolute;
            top: 70%;
        }
        .line-data.connected { border-color: var(--yellow); }

        /* GIANT RED ARROW (Handshake) */
        #big-arrow {
            position: absolute;
            top: 65%;
            height: 20px;
            background: var(--red);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 0.8rem;
            white-space: nowrap;
            box-shadow: 0 0 15px var(--red);
        }
        /* Arrow head */
        #big-arrow::after {
            content: '';
            position: absolute;
            width: 0; 
            height: 0; 
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
        }
        
        .arrow-l-to-r { /* Client -> Server */
            left: 0;
            transition: width 1.5s ease-out;
        }
        .arrow-l-to-r::after {
            right: -15px;
            border-left: 15px solid var(--red);
        }

        .arrow-r-to-l { /* Server -> Client */
            right: 0;
            transition: width 1.5s ease-out;
        }
        .arrow-r-to-l::after {
            left: -15px;
            border-right: 15px solid var(--red);
        }

        /* Packets */
        .packet {
            position: absolute;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
            z-index: 60;
            display: none;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            transition: left 1.5s linear; /* Smooth movement */
        }
        .pkt-ctrl { top: 20%; background: #fff; color: #000; border: 2px solid var(--blue); }
        .pkt-data { top: 65%; background: var(--yellow); color: #000; border: 2px solid #fff; font-size: 1.2rem; }

        /* Logger (Bottom) */
        .logger-container {
            width: 95%;
            max-width: 1400px;
            height: 25vh;
            background: #000;
            border: 2px solid #585b70;
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
        }
        .log-header {
            background: #333;
            color: #fff;
            padding: 5px 10px;
            font-size: 0.8rem;
            font-weight: bold;
            border-bottom: 1px solid #555;
        }
        .log-content {
            flex: 1;
            overflow-y: scroll;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.95rem;
            color: var(--green); /* Matrix style */
        }
        .log-line { margin-bottom: 5px; border-bottom: 1px solid #111; }
        .hl-cmd { color: #fff; background: #333; padding: 0 4px; }

        /* Controls */
        .controls {
            width: 95%;
            max-width: 1400px;
            background: var(--panel);
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            border: 1px solid var(--border);
        }

        button {
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 6px;
            border: none;
            background: #313244;
            color: #fff;
            transition: background 0.2s;
        }
        button:hover:not(:disabled) { background: #45475a; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        
        .btn-green { background: var(--green); color: #000; }
        .btn-green:hover:not(:disabled) { background: #8ebd89; }
        
        .mode-toggle {
            display: flex;
            background: #111;
            padding: 5px;
            border-radius: 6px;
        }
        .mode-toggle label {
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        input[type="radio"] { margin-right: 5px; }

    </style>
</head>
<body>

    <div id="main-status">Waiting for server to start...</div>

    <div class="grid-container">
        <!-- Client -->
        <div class="panel" id="panel-client">
            <div class="panel-header">
                CLIENT
                <span id="badge-client-status" style="font-size:0.8rem; color:#aaa">OFFLINE</span>
            </div>
            <div class="file-list" id="fs-client"></div>
            <div style="margin-top:auto; font-size:0.85rem; color:#aaa; border-top:1px solid #444; padding-top:5px;">
                <strong>Data Socket:</strong> <span id="sock-client" style="color:white">---</span>
            </div>
        </div>

        <!-- Network -->
        <div class="network-zone">
            <!-- Control -->
            <span class="channel-label" style="top: 20%">CONTROL (Port 3333)</span>
            <div class="line-control" id="line-ctrl"></div>
            <div class="packet pkt-ctrl" id="pkt-ctrl">CMD</div>

            <!-- Big Arrow -->
            <div id="big-arrow">TCP CONNECT...</div>

            <!-- Data -->
            <span class="channel-label" style="top: 65%">DATA (Dynamic Port)</span>
            <div class="line-data" id="line-data"></div>
            <div class="packet pkt-data" id="pkt-data">ðŸ“¦</div>
        </div>

        <!-- Server -->
        <div class="panel" id="panel-server">
            <div class="panel-header">
                SERVER
                <span id="badge-server-status" style="font-size:0.8rem; color:#aaa">STOPPED</span>
            </div>
            <div class="file-list" id="fs-server"></div>
            <div style="margin-top:auto; font-size:0.85rem; color:#aaa; border-top:1px solid #444; padding-top:5px;">
                <strong>Data Socket:</strong> <span id="sock-server" style="color:white">---</span>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <button onclick="startServer()" id="btn-start" class="btn-green">1. START SERVER</button>
        <button onclick="connectClient()" id="btn-conn" disabled>2. CONNECT</button>
        
        <div style="width:1px; height:30px; background:#555; margin:0 10px;"></div>
        
        <div class="mode-toggle">
            <label style="color:var(--yellow); font-weight:bold; border-right:1px solid #444">MODE:</label>
            <label><input type="radio" name="mode" value="active" checked> ACTIVE (Client Listens)</label>
            <label><input type="radio" name="mode" value="passive"> PASSIVE (Server Listens)</label>
        </div>

        <button onclick="cmdList()" id="btn-list" disabled>LIST</button>
        <button onclick="cmdGet()" id="btn-get" disabled>GET (Download)</button>
        <button onclick="cmdPut()" id="btn-put" disabled>PUT (Upload)</button>
        
        <button onclick="location.reload()" style="margin-left:auto; background:#f38ba8; color:#000">RESET</button>
    </div>

    <!-- Logger -->
    <div class="logger-container">
        <div class="log-header">SYSTEM LOG (Pseudo-FTP)</div>
        <div class="log-content" id="log-out">
            <div class="log-line">> System initialised.</div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const state = {
            sFiles: ['networking_course.pdf', 'server_log.txt', 'image.jpg'],
            cFiles: ['client_homework.py', 'notes.txt'],
            selS: null,
            selC: null,
            animating: false
        };

        // --- DOM Elements ---
        const el = {
            status: document.getElementById('main-status'),
            log: document.getElementById('log-out'),
            
            // Panels
            pClient: document.getElementById('panel-client'),
            pServer: document.getElementById('panel-server'),
            fsClient: document.getElementById('fs-client'),
            fsServer: document.getElementById('fs-server'),
            
            // Visuals
            lineCtrl: document.getElementById('line-ctrl'),
            lineData: document.getElementById('line-data'),
            pktCtrl: document.getElementById('pkt-ctrl'),
            pktData: document.getElementById('pkt-data'),
            arrow: document.getElementById('big-arrow'),
            
            // Sockets Info
            sockClient: document.getElementById('sock-client'),
            sockServer: document.getElementById('sock-server'),

            // Badges
            stClient: document.getElementById('badge-client-status'),
            stServer: document.getElementById('badge-server-status'),

            // Buttons
            btnStart: document.getElementById('btn-start'),
            btnConn: document.getElementById('btn-conn'),
            btnList: document.getElementById('btn-list'),
            btnGet: document.getElementById('btn-get'),
            btnPut: document.getElementById('btn-put')
        };

        // --- Utils ---
        function log(msg, source="SYS") {
            const line = document.createElement('div');
            line.className = 'log-line';
            line.innerHTML = `<span style="color:#666">[${new Date().toLocaleTimeString()}]</span> <b>${source}:</b> ${msg}`;
            el.log.appendChild(line);
            el.log.scrollTop = el.log.scrollHeight; // Force scroll bottom
        }

        function setStatus(msg) {
            el.status.innerText = msg;
        }

        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

        function renderFS() {
            el.fsServer.innerHTML = state.sFiles.map(f => 
                `<div class="file ${state.selS === f ? 'selected' : ''}" onclick="select('s','${f}')">ðŸ“„ ${f}</div>`
            ).join('');
            el.fsClient.innerHTML = state.cFiles.map(f => 
                `<div class="file ${state.selC === f ? 'selected' : ''}" onclick="select('c','${f}')">ðŸ“„ ${f}</div>`
            ).join('');
        }

        function select(side, f) {
            if(state.animating) return;
            if(side === 's') { state.selS = f; state.selC = null; }
            else { state.selC = f; state.selS = null; }
            renderFS();
        }

        // --- ANIMATIONS CORE ---
        
        async function movePacket(element, fromLeft) {
            // Reset
            element.style.display = 'block';
            element.style.transition = 'none';
            element.style.left = fromLeft ? '5%' : '85%';
            
            // Force Paint
            element.offsetHeight; 

            // Move
            element.style.transition = 'left 1.5s linear';
            element.style.left = fromLeft ? '85%' : '5%';

            await wait(1500);
            element.style.display = 'none';
        }

        async function drawConnectionArrow(direction) {
            // direction: 'LtoR' (Client->Server) or 'RtoL' (Server->Client)
            el.arrow.className = ''; // Reset classes
            el.arrow.style.display = 'flex';
            el.arrow.style.width = '0px';
            
            // Set position based on direction
            if(direction === 'LtoR') {
                el.arrow.classList.add('arrow-l-to-r');
                el.arrow.innerHTML = "CLIENT CONNECTING &rarr;";
            } else {
                el.arrow.classList.add('arrow-r-to-l');
                el.arrow.innerHTML = "&larr; SERVER CONNECTING";
            }

            el.arrow.offsetHeight; // Force Paint

            // Animate width
            el.arrow.style.width = '100%';
            
            await wait(1500);
        }

        function cleanupVisuals() {
            el.pClient.classList.remove('listening');
            el.pServer.classList.remove('listening');
            el.arrow.style.display = 'none';
            el.lineData.classList.remove('connected');
            el.sockClient.innerText = "---";
            el.sockServer.innerText = "---";
        }

        // --- ACTIONS ---

        function startServer() {
            log("Server started. Bind on 0.0.0.0:3333", "SERVER");
            el.stServer.innerText = "ONLINE";
            el.stServer.style.color = "#a6e3a1";
            el.btnStart.disabled = true;
            el.btnConn.disabled = false;
            setStatus("Server started. Connect the Client.");
            renderFS();
        }

        async function connectClient() {
            el.btnConn.disabled = true;
            log("Connecting to 127.0.0.1:3333...", "CLIENT");
            
            el.lineCtrl.classList.add('connected');
            await wait(500);
            
            el.stClient.innerText = "CONNECTED";
            el.stClient.style.color = "#a6e3a1";
            log("Control Connection Accepted!", "SERVER");
            
            el.btnList.disabled = false;
            el.btnGet.disabled = false;
            el.btnPut.disabled = false;
            setStatus("Control Connection Established. Choose a command.");
        }

        async function cmdList() {
            if(state.animating) return;
            state.animating = true;
            setStatus("LIST: Command only on control channel...");

            log("Sending: list", "CLIENT");
            el.pktCtrl.innerText = "LIST";
            await movePacket(el.pktCtrl, true); // C -> S

            await wait(200);
            log("Sending file list...", "SERVER");
            el.pktCtrl.innerText = "FILES...";
            await movePacket(el.pktCtrl, false); // S -> C

            log("List received.", "CLIENT");
            setStatus("Done.");
            state.animating = false;
        }

        async function cmdGet() {
            if(state.animating) return;
            const f = state.selS;
            if(!f) { alert("Select a file from SERVER (right)!"); return; }

            state.animating = true;
            const mode = document.querySelector('input[name="mode"]:checked').value;
            cleanupVisuals();

            try {
                if (mode === 'active') {
                    // --- ACTIVE GET ---
                    setStatus("ACTIVE MODE: 1. Client opens port and LISTENS.");
                    
                    // 1. Client Listen
                    const port = 10000 + Math.floor(Math.random()*1000);
                    log(`(Active) Opening port ${port} and entering LISTEN.`, "CLIENT");
                    el.pClient.classList.add('listening');
                    el.sockClient.innerText = `LISTEN :${port}`;
                    await wait(1500);

                    // 2. Send Command
                    setStatus("ACTIVE MODE: 2. Client sends IP + PORT to server.");
                    log(`Sending: active_get ${f} ${port}`, "CLIENT");
                    el.pktCtrl.innerText = `CMD+${port}`;
                    await movePacket(el.pktCtrl, true); // C -> S

                    // 3. Server Connect
                    setStatus("ACTIVE MODE: 3. Server INITIATES connection to Client.");
                    log(`Connecting to Client:${port}...`, "SERVER");
                    el.sockServer.innerText = `CONNECT -> :${port}`;
                    
                    // RED ARROW: S -> C
                    await drawConnectionArrow('RtoL');
                    el.lineData.classList.add('connected');

                    // 4. Data
                    setStatus("ACTIVE MODE: 4. Data transfer Server -> Client.");
                    log("Sending data...", "SERVER");
                    await movePacket(el.pktData, false); // S -> C

                    if(!state.cFiles.includes(f)) state.cFiles.push(f);
                    renderFS();
                    log("Transfer complete.", "CLIENT");

                } else {
                    // --- PASSIVE GET ---
                    setStatus("PASSIVE MODE: 1. Client requests passive_get.");
                    
                    // 1. Send Command
                    log(`Sending: passive_get ${f}`, "CLIENT");
                    el.pktCtrl.innerText = "PASV_GET";
                    await movePacket(el.pktCtrl, true); // C -> S

                    // 2. Server Listen
                    setStatus("PASSIVE MODE: 2. Server opens port and LISTENS.");
                    const port = 20000 + Math.floor(Math.random()*1000);
                    log(`(Passive) Opening port ${port} and entering LISTEN.`, "SERVER");
                    el.pServer.classList.add('listening');
                    el.sockServer.innerText = `LISTEN :${port}`;
                    await wait(1500);

                    // 3. Reply Port
                    setStatus("PASSIVE MODE: 3. Server sends port to Client.");
                    log(`Replying: Listening on ${port}`, "SERVER");
                    el.pktCtrl.innerText = `PORT:${port}`;
                    await movePacket(el.pktCtrl, false); // S -> C

                    // 4. Client Connect
                    setStatus("PASSIVE MODE: 4. Client INITIATES connection to Server.");
                    log(`Connecting to Server:${port}...`, "CLIENT");
                    el.sockClient.innerText = `CONNECT -> :${port}`;

                    // RED ARROW: C -> S
                    await drawConnectionArrow('LtoR');
                    el.lineData.classList.add('connected');

                    // 5. Data
                    setStatus("PASSIVE MODE: 5. Data transfer Server -> Client.");
                    log("Sending data...", "SERVER");
                    await movePacket(el.pktData, false); // S -> C

                    if(!state.cFiles.includes(f)) state.cFiles.push(f);
                    renderFS();
                    log("Transfer complete.", "CLIENT");
                }
            } finally {
                await wait(1000);
                cleanupVisuals();
                setStatus("Waiting for command...");
                state.animating = false;
            }
        }

        async function cmdPut() {
            if(state.animating) return;
            const f = state.selC;
            if(!f) { alert("Select a file from CLIENT (left)!"); return; }

            state.animating = true;
            const mode = document.querySelector('input[name="mode"]:checked').value;
            cleanupVisuals();

            try {
                if (mode === 'active') {
                    // --- ACTIVE PUT ---
                    setStatus("ACTIVE MODE (PUT): 1. Client LISTENS.");
                    const port = 10000 + Math.floor(Math.random()*1000);
                    el.pClient.classList.add('listening');
                    el.sockClient.innerText = `LISTEN :${port}`;
                    log(`Ready for upload on port ${port}`, "CLIENT");
                    await wait(1500);

                    setStatus("ACTIVE MODE (PUT): 2. Client sends PORT.");
                    el.pktCtrl.innerText = `PUT+${port}`;
                    await movePacket(el.pktCtrl, true);

                    setStatus("ACTIVE MODE (PUT): 3. Server connects.");
                    el.sockServer.innerText = `CONNECT -> :${port}`;
                    await drawConnectionArrow('RtoL'); // S -> C
                    el.lineData.classList.add('connected');

                    setStatus("ACTIVE MODE (PUT): 4. Client sends data.");
                    await movePacket(el.pktData, true); // C -> S

                    if(!state.sFiles.includes(f)) state.sFiles.push(f);
                    renderFS();
                    log("File received.", "SERVER");

                } else {
                    // --- PASSIVE PUT ---
                    setStatus("PASSIVE MODE (PUT): 1. Client requests upload.");
                    el.pktCtrl.innerText = "PASV_PUT";
                    await movePacket(el.pktCtrl, true);

                    setStatus("PASSIVE MODE (PUT): 2. Server LISTENS.");
                    const port = 30000 + Math.floor(Math.random()*1000);
                    el.pServer.classList.add('listening');
                    el.sockServer.innerText = `LISTEN :${port}`;
                    await wait(1500);

                    setStatus("PASSIVE MODE (PUT): 3. Server sends PORT.");
                    el.pktCtrl.innerText = `PORT:${port}`;
                    await movePacket(el.pktCtrl, false);

                    setStatus("PASSIVE MODE (PUT): 4. Client connects.");
                    el.sockClient.innerText = `CONNECT -> :${port}`;
                    await drawConnectionArrow('LtoR'); // C -> S
                    el.lineData.classList.add('connected');

                    setStatus("PASSIVE MODE (PUT): 5. Client sends data.");
                    await movePacket(el.pktData, true); // C -> S

                    if(!state.sFiles.includes(f)) state.sFiles.push(f);
                    renderFS();
                    log("File received.", "SERVER");
                }
            } finally {
                await wait(1000);
                cleanupVisuals();
                setStatus("Waiting for command...");
                state.animating = false;
            }
        }

        // Init
        renderFS();
        log("Select a file and an action.");

    </script>
</body>
</html>