<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mininet Network Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }

        .terminal-font {
            font-family: 'Fira Code', monospace;
        }

        /* CRT Effect for Terminal */
        .crt-container {
            position: relative;
            overflow: hidden;
        }
        
        .scanline {
            width: 100%;
            height: 100px;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(51, 255, 51, 0.02) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scanline 10s linear infinite;
            pointer-events: none;
        }

        @keyframes scanline {
            0% { bottom: 100%; }
            100% { bottom: -100px; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }

        /* Animation for Packets */
        .packet {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #fbbf24;
            border-radius: 50%;
            box-shadow: 0 0 10px #fbbf24;
            z-index: 50;
            transform: translate(-50%, -50%);
            transition: left 0.5s linear, top 0.5s linear, opacity 0.2s;
        }

        .packet.icmp-reply {
            background-color: #34d399; /* Green for reply */
            box-shadow: 0 0 10px #34d399;
        }

        .packet.dropped {
            background-color: #ef4444; /* Red for drop */
            box-shadow: 0 0 10px #ef4444;
            animation: dissolve 0.5s forwards;
        }

        @keyframes dissolve {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }

        .node-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        .cable {
            stroke-dasharray: 10;
            animation: flow 20s linear infinite;
        }
        
        @keyframes flow {
            to { stroke-dashoffset: -200; }
        }

        /* Blink cursor */
        .cursor {
            display: inline-block;
            width: 10px;
            height: 1.2em;
            background-color: #4ade80;
            animation: blink 1s step-end infinite;
            vertical-align: middle;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-700 p-4 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg">
                <i class="fas fa-network-wired text-white text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-xl text-white">Mininet Network Simulator</h1>
                <p class="text-xs text-slate-400">Lab 3: IP Routing & Forwarding</p>
            </div>
        </div>
        <div class="flex gap-4 text-sm text-slate-300">
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-blue-500"></span> IPv4 Subnet A
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-purple-500"></span> IPv4 Subnet B
            </div>
            <button onclick="app.resetSimulation()" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs border border-slate-600 transition">
                <i class="fas fa-undo mr-1"></i> Reset Lab
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- Topology Visualization (Left) -->
        <section class="flex-1 bg-slate-800 relative flex flex-col" id="topology-container">
            <div class="absolute top-4 left-4 z-10 bg-slate-900/80 backdrop-blur border border-slate-700 p-3 rounded-lg text-xs">
                <p class="font-bold text-slate-200 mb-1">Status Overlay</p>
                <div id="status-r1-fwd" class="flex items-center gap-2 text-red-400">
                    <i class="fas fa-times-circle"></i> r1 IP Fwd: DISABLED
                </div>
                <div id="status-r1-dump" class="flex items-center gap-2 text-slate-500 mt-1">
                    <i class="fas fa-eye-slash"></i> r1 tcpdump: OFF
                </div>
            </div>

            <!-- SVG Graph -->
            <div class="flex-1 relative overflow-hidden" id="canvas-area">
                <svg width="100%" height="100%" class="absolute inset-0 pointer-events-none">
                    <!-- Connections -->
                    <line id="link-h1-r1" x1="20%" y1="50%" x2="50%" y2="50%" stroke="#3b82f6" stroke-width="4" class="cable opacity-50"/>
                    <line id="link-h2-r1" x1="80%" y1="50%" x2="50%" y2="50%" stroke="#a855f7" stroke-width="4" class="cable opacity-50"/>
                </svg>

                <!-- Nodes -->
                <!-- H1 -->
                <div class="absolute top-1/2 left-[20%] -translate-x-1/2 -translate-y-1/2 flex flex-col items-center gap-2 group cursor-pointer" onclick="app.typeCommand('h1 ip a')">
                    <div class="w-20 h-20 bg-slate-700 rounded-xl border-2 border-blue-500 flex items-center justify-center node-shadow relative">
                        <i class="fas fa-desktop text-3xl text-blue-400"></i>
                        <div class="absolute -top-3 -right-3 w-6 h-6 bg-slate-900 border border-slate-600 rounded-full flex items-center justify-center text-xs font-bold text-slate-300">h1</div>
                    </div>
                    <div class="text-center bg-slate-900/80 p-2 rounded border border-slate-700 backdrop-blur">
                        <div class="font-bold text-blue-400">10.0.1.10</div>
                        <div class="text-[10px] text-slate-400 font-mono">GW: <span id="h1-gw">None</span></div>
                    </div>
                </div>

                <!-- R1 -->
                <div class="absolute top-1/2 left-[50%] -translate-x-1/2 -translate-y-1/2 flex flex-col items-center gap-2 group cursor-pointer" onclick="app.typeCommand('r1 ip a')">
                    <div class="w-24 h-24 bg-slate-700 rounded-full border-4 border-slate-600 flex items-center justify-center node-shadow relative z-20">
                        <i class="fas fa-server text-4xl text-slate-300"></i>
                        <div class="absolute -top-1 -right-1 w-8 h-8 bg-slate-900 border border-slate-600 rounded-full flex items-center justify-center text-sm font-bold text-slate-300">r1</div>
                    </div>
                    <div class="flex gap-8 text-xs font-mono mt-1">
                        <div class="text-blue-400">eth0: 10.0.1.1</div>
                        <div class="text-purple-400">eth1: 10.0.2.1</div>
                    </div>
                </div>

                <!-- H2 -->
                <div class="absolute top-1/2 left-[80%] -translate-x-1/2 -translate-y-1/2 flex flex-col items-center gap-2 group cursor-pointer" onclick="app.typeCommand('h2 ip a')">
                    <div class="w-20 h-20 bg-slate-700 rounded-xl border-2 border-purple-500 flex items-center justify-center node-shadow relative">
                        <i class="fas fa-desktop text-3xl text-purple-400"></i>
                        <div class="absolute -top-3 -right-3 w-6 h-6 bg-slate-900 border border-slate-600 rounded-full flex items-center justify-center text-xs font-bold text-slate-300">h2</div>
                    </div>
                    <div class="text-center bg-slate-900/80 p-2 rounded border border-slate-700 backdrop-blur">
                        <div class="font-bold text-purple-400">10.0.2.10</div>
                        <div class="text-[10px] text-slate-400 font-mono">GW: <span id="h2-gw">None</span></div>
                    </div>
                </div>

                <!-- Packet Container -->
                <div id="packet-layer" class="absolute inset-0 pointer-events-none"></div>
            </div>

            <!-- Tcpdump Panel (Hidden by default) -->
            <div id="tcpdump-panel" class="hidden absolute bottom-0 left-0 right-0 h-48 bg-black/90 border-t border-slate-700 font-mono text-xs p-2 overflow-y-auto">
                <div class="flex justify-between items-center border-b border-slate-800 pb-1 mb-2 sticky top-0 bg-black/90">
                    <span class="text-green-400 font-bold">root@r1:~# tcpdump -i any -n</span>
                    <button onclick="app.toggleTcpdump()" class="text-red-400 hover:text-white"><i class="fas fa-times"></i> Close</button>
                </div>
                <div id="tcpdump-output" class="text-slate-300 space-y-1"></div>
            </div>
        </section>

        <!-- Sidebar (Tasks & Info) -->
        <aside class="w-80 bg-slate-900 border-l border-slate-700 flex flex-col shrink-0">
            <div class="p-4 border-b border-slate-700 font-bold text-slate-200">
                Lab Tasks
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                
                <div class="task-item opacity-50" id="task-1">
                    <div class="flex gap-3">
                        <div class="mt-1"><i class="far fa-square text-slate-500 check-icon"></i></div>
                        <div>
                            <h3 class="font-semibold text-sm text-slate-300">1. Verify Interfaces</h3>
                            <p class="text-xs text-slate-500 mt-1">Check IP configurations.</p>
                            <code class="block bg-slate-800 p-1 mt-2 text-xs rounded text-blue-300 cursor-pointer hover:bg-slate-700" onclick="app.typeCommand('h1 ip a')">h1 ip a</code>
                        </div>
                    </div>
                </div>

                <div class="task-item opacity-50" id="task-2">
                    <div class="flex gap-3">
                        <div class="mt-1"><i class="far fa-square text-slate-500 check-icon"></i></div>
                        <div>
                            <h3 class="font-semibold text-sm text-slate-300">2. Local Connectivity</h3>
                            <p class="text-xs text-slate-500 mt-1">Ping local gateway from h1.</p>
                            <code class="block bg-slate-800 p-1 mt-2 text-xs rounded text-blue-300 cursor-pointer hover:bg-slate-700" onclick="app.typeCommand('h1 ping -c 1 10.0.1.1')">h1 ping -c 1 10.0.1.1</code>
                        </div>
                    </div>
                </div>

                <div class="task-item opacity-50" id="task-3">
                    <div class="flex gap-3">
                        <div class="mt-1"><i class="far fa-square text-slate-500 check-icon"></i></div>
                        <div>
                            <h3 class="font-semibold text-sm text-slate-300">3. Enable Forwarding</h3>
                            <p class="text-xs text-slate-500 mt-1">Configure r1 to forward packets.</p>
                            <code class="block bg-slate-800 p-1 mt-2 text-xs rounded text-blue-300 cursor-pointer hover:bg-slate-700" onclick="app.typeCommand('r1 sysctl -w net.ipv4.ip_forward=1')">r1 sysctl -w net.ipv4.ip_forward=1</code>
                        </div>
                    </div>
                </div>

                <div class="task-item opacity-50" id="task-4">
                    <div class="flex gap-3">
                        <div class="mt-1"><i class="far fa-square text-slate-500 check-icon"></i></div>
                        <div>
                            <h3 class="font-semibold text-sm text-slate-300">4. Add Default Routes</h3>
                            <p class="text-xs text-slate-500 mt-1">Hosts need to know where to send remote traffic.</p>
                            <code class="block bg-slate-800 p-1 mt-2 text-xs rounded text-blue-300 cursor-pointer hover:bg-slate-700" onclick="app.typeCommand('h1 ip route add default via 10.0.1.1')">h1 ip route add default via 10.0.1.1</code>
                            <code class="block bg-slate-800 p-1 mt-1 text-xs rounded text-blue-300 cursor-pointer hover:bg-slate-700" onclick="app.typeCommand('h2 ip route add default via 10.0.2.1')">h2 ip route add default via 10.0.2.1</code>
                        </div>
                    </div>
                </div>

                <div class="task-item opacity-50" id="task-5">
                    <div class="flex gap-3">
                        <div class="mt-1"><i class="far fa-square text-slate-500 check-icon"></i></div>
                        <div>
                            <h3 class="font-semibold text-sm text-slate-300">5. End-to-End Test</h3>
                            <p class="text-xs text-slate-500 mt-1">Ping h2 from h1 across the router.</p>
                            <code class="block bg-slate-800 p-1 mt-2 text-xs rounded text-blue-300 cursor-pointer hover:bg-slate-700" onclick="app.typeCommand('h1 ping -c 1 10.0.2.10')">h1 ping -c 1 10.0.2.10</code>
                        </div>
                    </div>
                </div>
                
                <div class="task-item opacity-50" id="task-6">
                    <div class="flex gap-3">
                        <div class="mt-1"><i class="far fa-square text-slate-500 check-icon"></i></div>
                        <div>
                            <h3 class="font-semibold text-sm text-slate-300">6. Analyse Traffic</h3>
                            <p class="text-xs text-slate-500 mt-1">Use tcpdump on r1 while pinging.</p>
                             <code class="block bg-slate-800 p-1 mt-2 text-xs rounded text-blue-300 cursor-pointer hover:bg-slate-700" onclick="app.typeCommand('r1 tcpdump -i r1-eth0 -n')">r1 tcpdump -i r1-eth0 -n</code>
                        </div>
                    </div>
                </div>

            </div>
        </aside>
    </main>

    <!-- Terminal Simulation -->
    <div class="h-64 bg-black border-t border-slate-700 p-2 terminal-font text-sm flex flex-col crt-container shrink-0">
        <div class="scanline"></div>
        <div class="flex-1 overflow-y-auto mb-2" id="terminal-output">
            <div class="text-slate-500 mb-2">Mininet 2.3.0</div>
            <div class="text-slate-300">Type "help" for a list of commands. Follow the lab tasks.</div>
            <div class="text-slate-300">Format: <span class="text-yellow-400">[node] [command] [args]</span></div>
            <br>
        </div>
        <div class="flex items-center gap-2 text-green-400 font-bold border-t border-slate-800 pt-2">
            <span>mininet></span>
            <input type="text" id="terminal-input" class="bg-transparent border-none outline-none flex-1 text-green-400 font-normal" autofocus placeholder="h1 ping 10.0.2.10..." autocomplete="off">
            <div class="cursor"></div>
        </div>
    </div>

    <script>
        // --- Simulation Logic ---

        class NetworkNode {
            constructor(name, ip, gateway = null) {
                this.name = name;
                this.interfaces = {}; // e.g., 'eth0': '10.0.1.10'
                this.routes = []; // { dest: '0.0.0.0/0', gw: '10.0.1.1' }
                this.forwarding = false;
            }

            addInterface(name, ip, mask) {
                this.interfaces[name] = { ip, mask };
            }

            addRoute(dest, gw) {
                this.routes.push({ dest, gw });
            }
        }

        const app = {
            nodes: {},
            tcpdumpActive: false,
            tcpdumpFilter: null,
            tasksCompleted: new Set(),
            
            init() {
                this.resetSimulation();
                this.setupEventListeners();
                this.updateUI();
            },

            resetSimulation() {
                // Initialize per S05_Part03B_Script_Mininet_Topology.py but adhering to 3c tasks flow
                this.nodes = {
                    h1: new NetworkNode('h1'),
                    h2: new NetworkNode('h2'),
                    r1: new NetworkNode('r1')
                };

                // Setup IPs (Tasks 1)
                this.nodes.h1.addInterface('h1-eth0', '10.0.1.10', 24);
                this.nodes.h2.addInterface('h2-eth0', '10.0.2.10', 24);
                this.nodes.r1.addInterface('r1-eth0', '10.0.1.1', 24);
                this.nodes.r1.addInterface('r1-eth1', '10.0.2.1', 24);

                // Default Routes (Initially missing per Lab Task 4)
                // Forwarding (Initially disabled per Lab Task 3)

                this.tcpdumpActive = false;
                this.tasksCompleted.clear();
                this.printToTerminal("Simulation reset. Network is cold.", "text-blue-400");
                this.updateUI();
                this.updateTaskUI();
            },

            setupEventListeners() {
                const input = document.getElementById('terminal-input');
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const cmd = input.value.trim();
                        if (cmd) {
                            this.executeCommand(cmd);
                            input.value = '';
                        }
                    }
                });

                // Focus terminal on click anywhere
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('button') && !e.target.closest('code')) {
                        input.focus();
                    }
                });
            },

            typeCommand(cmd) {
                const input = document.getElementById('terminal-input');
                input.value = "";
                let i = 0;
                const speed = 30; 
                
                const typeChar = () => {
                    if (i < cmd.length) {
                        input.value += cmd.charAt(i);
                        i++;
                        setTimeout(typeChar, speed);
                    } else {
                        setTimeout(() => this.executeCommand(cmd), 200);
                        input.value = "";
                    }
                };
                typeChar();
            },

            printToTerminal(text, colorClass = "text-slate-300") {
                const term = document.getElementById('terminal-output');
                const div = document.createElement('div');
                div.className = colorClass;
                // Handle newlines
                div.innerHTML = text.replace(/\n/g, '<br>');
                term.appendChild(div);
                term.scrollTop = term.scrollHeight;
            },

            executeCommand(rawCmd) {
                this.printToTerminal(`mininet> ${rawCmd}`, "font-bold text-white");
                
                const parts = rawCmd.split(' ');
                const host = parts[0];
                const command = parts[1];
                const args = parts.slice(2);

                if (!this.nodes[host]) {
                    this.printToTerminal(`Node '${host}' not found. Available: h1, r1, h2`, "text-red-400");
                    return;
                }

                switch (command) {
                    case 'ip':
                        if (args[0] === 'a' || args[0] === 'addr') {
                            this.handleIpAddr(host);
                        } else if (args[0] === 'route') {
                            this.handleIpRoute(host, args);
                        } else {
                            this.printToTerminal("Unknown ip command. Try 'ip a' or 'ip route'", "text-yellow-400");
                        }
                        break;

                    case 'ping':
                        this.handlePing(host, args);
                        break;
                    
                    case 'traceroute':
                        this.handleTraceroute(host, args);
                        break;

                    case 'sysctl':
                        this.handleSysctl(host, args);
                        break;

                    case 'tcpdump':
                        this.handleTcpdump(host, args);
                        break;

                    default:
                        this.printToTerminal(`Command '${command}' not found on ${host}.`, "text-red-400");
                }
            },

            // --- Command Handlers ---

            handleIpAddr(hostName) {
                const node = this.nodes[hostName];
                let output = `1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever`;
                
                let idx = 2;
                for (const [intf, data] of Object.entries(node.interfaces)) {
                    output += `\n${idx}: ${intf}: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000\n    link/ether ${this.generateMac(hostName)} brd ff:ff:ff:ff:ff:ff\n    inet ${data.ip}/${data.mask} brd 10.0.${idx-1}.255 scope global ${intf}\n       valid_lft forever preferred_lft forever`;
                    idx++;
                }
                this.printToTerminal(output);
                this.markTaskComplete(1);
            },

            handleSysctl(hostName, args) {
                // r1 sysctl -w net.ipv4.ip_forward=1
                const keyVal = args.find(a => a.includes('='));
                
                if (args.includes('net.ipv4.ip_forward')) {
                     // Read mode
                     const status = this.nodes[hostName].forwarding ? '1' : '0';
                     this.printToTerminal(`net.ipv4.ip_forward = ${status}`);
                } else if (keyVal && keyVal.includes('net.ipv4.ip_forward=1')) {
                    // Write mode
                    if (hostName !== 'r1') {
                        this.printToTerminal(`Error: ${hostName} is a host, not a router.`, "text-red-400");
                        return;
                    }
                    this.nodes.r1.forwarding = true;
                    this.printToTerminal(`net.ipv4.ip_forward = 1`);
                    this.updateUI();
                    this.markTaskComplete(3);
                } else if (keyVal && keyVal.includes('net.ipv4.ip_forward=0')) {
                    this.nodes.r1.forwarding = false;
                    this.printToTerminal(`net.ipv4.ip_forward = 0`);
                    this.updateUI();
                } else {
                    this.printToTerminal("Usage: sysctl -w net.ipv4.ip_forward=1", "text-yellow-400");
                }
            },

            handleIpRoute(hostName, args) {
                // ip route add default via X.X.X.X
                if (args[1] === 'add' && args[2] === 'default' && args[3] === 'via') {
                    const gw = args[4];
                    // Basic validation
                    if (!this.isValidIP(gw)) {
                        this.printToTerminal("Invalid IP address", "text-red-400");
                        return;
                    }
                    this.nodes[hostName].routes = [{dest: '0.0.0.0/0', gw: gw}];
                    this.printToTerminal(""); // Success is silent in Linux usually, but user needs feedback? Mininet CLI is silent on success.
                    this.updateUI();
                    this.markTaskComplete(4);
                } else {
                    this.printToTerminal("Supported: ip route add default via <IP>", "text-yellow-400");
                }
            },

            handlePing(srcName, args) {
                // h1 ping -c 3 10.0.2.10
                let destIP = args[args.length - 1];
                let count = 3; // Default
                if (args.includes('-c')) {
                    const idx = args.indexOf('-c');
                    if (args[idx+1]) count = parseInt(args[idx+1]);
                }

                this.printToTerminal(`PING ${destIP} (${destIP}) 56(84) bytes of data.`);
                
                let seq = 1;
                const interval = setInterval(() => {
                    if (seq > count) {
                        clearInterval(interval);
                        this.printToTerminal(`--- ${destIP} ping statistics ---`);
                        this.printToTerminal(`${count} packets transmitted, ${count} received, 0% packet loss`);
                        return;
                    }

                    this.simulatePacket(srcName, destIP, (success, msg, type) => {
                        if (success) {
                            this.printToTerminal(`64 bytes from ${destIP}: icmp_seq=${seq} ttl=64 time=0.0${Math.floor(Math.random()*9)} ms`);
                            // Check task completions
                            if (srcName === 'h1' && (destIP === '10.0.1.1')) this.markTaskComplete(2);
                            if (srcName === 'h1' && destIP === '10.0.2.10') this.markTaskComplete(5);
                        } else {
                            this.printToTerminal(`From ${msg || 'Gateway'}: icmp_seq=${seq} Destination Host Unreachable`, "text-yellow-400");
                        }
                    }, 'icmp');
                    seq++;
                }, 1200); // 1.2s delay between pings for animation
            },

            handleTraceroute(srcName, args) {
                const destIP = args[args.length - 1];
                this.printToTerminal(`traceroute to ${destIP} (${destIP}), 30 hops max, 60 byte packets`);

                // Simplified traceroute logic for this topology
                // 1. Check local gateway
                // 2. Check remote
                
                let step = 1;
                const runHop = (hopIP, name, isFinal) => {
                    setTimeout(() => {
                        this.printToTerminal(` ${step}  ${name || hopIP} (${hopIP})  0.0${Math.floor(Math.random()*9)} ms  0.0${Math.floor(Math.random()*9)} ms  0.0${Math.floor(Math.random()*9)} ms`);
                        step++;
                        if (!isFinal) {
                            // next hop
                        } else {
                            if(srcName === 'h1' && destIP === '10.0.2.10') this.markTaskComplete(6);
                        }
                    }, step * 500);
                }

                // Logic:
                // Is dest local?
                if (this.isLocal(srcName, destIP)) {
                    runHop(destIP, this.getNodeNameByIP(destIP), true);
                    return;
                }

                // Is GW set?
                const gw = this.nodes[srcName].routes.find(r => r.dest === '0.0.0.0/0')?.gw;
                if (!gw) {
                    this.printToTerminal(` 1  * * *`);
                    return;
                }

                // Can we reach GW?
                runHop(gw, 'r1', false);

                // Is forwarding on?
                if (!this.nodes.r1.forwarding) {
                     setTimeout(() => this.printToTerminal(` 2  * * *`), 1000);
                     return;
                }

                // Is dest reachable from GW?
                if (this.isLocal('r1', destIP)) {
                     setTimeout(() => runHop(destIP, 'h2', true), 500);
                }
            },

            handleTcpdump(hostName, args) {
                if (hostName !== 'r1') {
                    this.printToTerminal("tcpdump is usually run on the router/switch.", "text-yellow-400");
                    return;
                }
                const panel = document.getElementById('tcpdump-panel');
                panel.classList.remove('hidden');
                document.getElementById('tcpdump-output').innerHTML = ""; // Clear old
                this.tcpdumpActive = true;
                this.printToTerminal(`tcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on r1-eth0, link-type EN10MB (Ethernet), capture size 262144 bytes`);
                this.markTaskComplete(6); // technically part of the flow
            },

            toggleTcpdump() {
                const panel = document.getElementById('tcpdump-panel');
                panel.classList.add('hidden');
                this.tcpdumpActive = false;
                this.printToTerminal("\n[1]+  Stopped                 tcpdump");
            },

            logTcpdump(srcIP, destIP, proto) {
                if (!this.tcpdumpActive) return;
                const div = document.getElementById('tcpdump-output');
                const time = new Date().toLocaleTimeString('en-GB', { hour12: false }) + '.' + Math.floor(Math.random()*100000);
                const line = `<div class="font-mono text-[10px] whitespace-nowrap">${time} IP ${srcIP} > ${destIP}: ${proto.toUpperCase()} echo request, id 1337, seq 1, length 64</div>`;
                const lineRep = `<div class="font-mono text-[10px] whitespace-nowrap">${time} IP ${destIP} > ${srcIP}: ${proto.toUpperCase()} echo reply, id 1337, seq 1, length 64</div>`;
                
                div.innerHTML += line;
                setTimeout(() => { if(this.tcpdumpActive) div.innerHTML += lineRep; }, 500);
                div.scrollTop = div.scrollHeight;
            },

            // --- Packet Engine ---

            simulatePacket(srcName, destIP, callback, type = 'icmp') {
                const srcNode = this.nodes[srcName];
                const destNodeName = this.getNodeNameByIP(destIP);
                
                // 1. Local Subnet Check
                if (this.isLocal(srcName, destIP)) {
                    // Direct Link
                    if (destNodeName === 'r1') {
                        // h1 -> r1 (local interface)
                        this.animatePacket(srcName, 'r1', true, () => callback(true));
                    } else if (destNodeName) {
                        // Direct connection? Not in this topology (h1-h2 not direct)
                        // Should technically fail if user thinks h1 can ping h2 directly without gw
                        callback(false, srcNode.interfaces[Object.keys(srcNode.interfaces)[0]].ip); 
                    } else {
                        callback(false);
                    }
                    return;
                }

                // 2. Routing Check
                const gw = srcNode.routes.find(r => r.dest === '0.0.0.0/0')?.gw;
                if (!gw) {
                    this.animatePacket(srcName, null, false); // drop immediately
                    setTimeout(() => callback(false, 'Network is unreachable'), 500);
                    return;
                }

                // 3. Send to Gateway
                this.animatePacket(srcName, 'r1', true, () => {
                    // At Router
                    // Check Forwarding
                    if (!this.nodes.r1.forwarding) {
                        this.animateDrop('r1');
                         // Log to tcpdump if listening on input interface
                        if(type === 'icmp') this.logTcpdump(this.getIP(srcName), destIP, type);
                        setTimeout(() => callback(false, '10.0.1.1'), 500); // Admin prohibited / unreachable
                        return;
                    }

                    // Log to tcpdump
                    if(type === 'icmp') this.logTcpdump(this.getIP(srcName), destIP, type);

                    // Check if router knows dest
                    if (this.isLocal('r1', destIP)) {
                        // Forward to H2
                        this.animatePacket('r1', 'h2', true, () => {
                             // Success Return Path
                             this.animatePacket('h2', 'r1', true, () => {
                                 this.animatePacket('r1', srcName, true, () => {
                                     callback(true);
                                 }, 'reply');
                             }, 'reply');
                        });
                    } else {
                        // Unknown dest
                        this.animateDrop('r1');
                        callback(false, '10.0.1.1');
                    }
                });
            },

            animatePacket(fromNode, toNode, success, onFinish, variant = 'req') {
                const container = document.getElementById('packet-layer');
                const packet = document.createElement('div');
                packet.className = `packet ${variant === 'reply' ? 'icmp-reply' : ''}`;
                
                const startPos = this.getNodePos(fromNode);
                const endPos = toNode ? this.getNodePos(toNode) : { left: startPos.left, top: startPos.top + 50 }; // Drop slightly below if null

                packet.style.left = startPos.left + 'px';
                packet.style.top = startPos.top + 'px';
                
                container.appendChild(packet);

                // Force reflow
                packet.offsetHeight;

                packet.style.left = endPos.left + 'px';
                packet.style.top = endPos.top + 'px';
                if (!toNode) packet.style.opacity = 0;

                setTimeout(() => {
                    packet.remove();
                    if (onFinish) onFinish();
                }, 500);
            },

            animateDrop(atNode) {
                const container = document.getElementById('packet-layer');
                const packet = document.createElement('div');
                packet.className = 'packet dropped';
                const pos = this.getNodePos(atNode);
                packet.style.left = pos.left + 'px';
                packet.style.top = pos.top + 'px';
                container.appendChild(packet);
                setTimeout(() => packet.remove(), 600);
            },

            getNodePos(name) {
                // Hardcoded percentages from CSS to pixels
                const w = document.getElementById('topology-container').offsetWidth;
                const h = document.getElementById('topology-container').offsetHeight;
                
                const positions = {
                    'h1': { left: w * 0.2, top: h * 0.5 },
                    'r1': { left: w * 0.5, top: h * 0.5 },
                    'h2': { left: w * 0.8, top: h * 0.5 }
                };
                return positions[name];
            },

            // --- Helpers ---

            isLocal(nodeName, targetIP) {
                // Simplified Subnet logic /24
                // h1 (10.0.1.x) can reach 10.0.1.x
                const nodeIP = this.getIP(nodeName);
                if (!nodeIP) return false; // r1 has two IPs, need check both
                
                const subnet1 = '10.0.1.';
                const subnet2 = '10.0.2.';

                if (nodeName === 'r1') {
                     return targetIP.startsWith(subnet1) || targetIP.startsWith(subnet2);
                }
                
                const mySubnet = nodeIP.substring(0, 7); // 10.0.1.
                return targetIP.startsWith(mySubnet);
            },

            getIP(nodeName) {
                if (nodeName === 'h1') return '10.0.1.10';
                if (nodeName === 'h2') return '10.0.2.10';
                return '10.0.1.1'; // Primary for r1 check
            },

            getNodeNameByIP(ip) {
                if (ip === '10.0.1.10') return 'h1';
                if (ip === '10.0.2.10') return 'h2';
                if (ip === '10.0.1.1' || ip === '10.0.2.1') return 'r1';
                return null;
            },

            generateMac(host) {
                // Fake MAC for realism
                const map = { 'h1': '00:00:00:00:00:01', 'h2': '00:00:00:00:00:02', 'r1': '00:00:00:00:00:FE' };
                return map[host] || 'FF:FF:FF:FF:FF:FF';
            },
            
            isValidIP(ip) {
                return /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ip);
            },

            markTaskComplete(id) {
                this.tasksCompleted.add(id);
                this.updateTaskUI();
            },

            updateTaskUI() {
                // Update opacity and icons
                for(let i=1; i<=6; i++) {
                    const el = document.getElementById(`task-${i}`);
                    const icon = el.querySelector('.check-icon');
                    if (this.tasksCompleted.has(i)) {
                        el.classList.remove('opacity-50');
                        el.classList.add('opacity-100');
                        icon.className = 'fas fa-check-square text-green-400 check-icon';
                    } else {
                        // Highlight next available task
                        if (i === 1 || this.tasksCompleted.has(i-1)) {
                             el.classList.remove('opacity-50');
                             el.classList.add('opacity-100', 'bg-slate-800/50', 'rounded');
                        } else {
                             el.classList.add('opacity-50');
                             el.classList.remove('opacity-100');
                        }
                    }
                }
            },

            updateUI() {
                // Update Topology Statuses
                const fwdStatus = document.getElementById('status-r1-fwd');
                if (this.nodes.r1.forwarding) {
                    fwdStatus.innerHTML = '<i class="fas fa-check-circle"></i> r1 IP Fwd: ENABLED';
                    fwdStatus.className = 'flex items-center gap-2 text-green-400';
                } else {
                    fwdStatus.innerHTML = '<i class="fas fa-times-circle"></i> r1 IP Fwd: DISABLED';
                    fwdStatus.className = 'flex items-center gap-2 text-red-400';
                }

                const dumpStatus = document.getElementById('status-r1-dump');
                if (this.tcpdumpActive) {
                    dumpStatus.innerHTML = '<i class="fas fa-eye"></i> r1 tcpdump: CAPTURING';
                    dumpStatus.className = 'flex items-center gap-2 text-green-400 mt-1 animate-pulse';
                } else {
                    dumpStatus.innerHTML = '<i class="fas fa-eye-slash"></i> r1 tcpdump: OFF';
                    dumpStatus.className = 'flex items-center gap-2 text-slate-500 mt-1';
                }

                // Update GW displays
                document.getElementById('h1-gw').innerText = this.nodes.h1.routes.length ? this.nodes.h1.routes[0].gw : 'None';
                document.getElementById('h2-gw').innerText = this.nodes.h2.routes.length ? this.nodes.h2.routes[0].gw : 'None';
            }
        };

        // Boot
        window.onload = () => app.init();

    </script>
</body>
</html>