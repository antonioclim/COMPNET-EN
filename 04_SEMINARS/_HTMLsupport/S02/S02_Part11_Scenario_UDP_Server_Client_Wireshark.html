<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UDP Lab Simulator: Server, Netcat & Wireshark</title>
    <style>
        :root {
            --bg-app: #1e1e1e;
            --bg-panel: #252526;
            --term-bg: #0c0c0c;
            --wireshark-bg: #ffffff;
            --text-main: #cccccc;
            --text-bright: #ffffff;
            --accent: #d16969; /* UDP Red */
            --accent-green: #6a9955;
            --accent-blue: #4daafc;
            --border: #333;
            --font-mono: 'Consolas', 'Monaco', monospace;
            --font-sans: 'Segoe UI', sans-serif;
            
            /* Wireshark Colours */
            --ws-selected: #e1f5fe;
            --ws-udp: #dae8fc; /* Light Blue for UDP in standard WS themes */
            --ws-header: #e6e6e6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-app);
            color: var(--text-main);
            font-family: var(--font-sans);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background: var(--bg-panel);
            padding: 0 1.5rem;
            height: 60px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
            justify-content: space-between;
        }
        
        h1 { font-size: 1.1rem; font-weight: 600; color: var(--text-bright); }
        .subtitle { font-size: 0.8rem; color: #888; margin-left: 10px; }

        /* --- Main Workspace --- */
        main {
            flex: 1;
            display: grid;
            grid-template-rows: 60% 40%;
            overflow: hidden;
        }

        .terminals-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-bottom: 4px solid var(--border);
        }

        /* --- Terminal Components --- */
        .terminal-window {
            background-color: var(--term-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            overflow: hidden;
        }

        .term-header {
            background: #333;
            padding: 5px 10px;
            font-size: 0.75rem;
            color: #ddd;
            display: flex;
            justify-content: space-between;
        }

        .term-body {
            padding: 10px;
            flex: 1;
            overflow-y: auto;
            color: #d4d4d4;
            white-space: pre-wrap;
        }

        .cursor {
            display: inline-block;
            width: 8px;
            height: 15px;
            background: #ccc;
            animation: blink 1s step-end infinite;
            vertical-align: middle;
        }

        @keyframes blink { 50% { opacity: 0; } }

        /* Terminal Prompt Colours */
        .prompt-server { color: var(--accent); }
        .prompt-client { color: var(--accent-blue); }
        .cmd-text { color: #ffffff; }
        .log-info { color: #888; }
        .log-success { color: var(--accent-green); }

        /* --- Wireshark Simulation --- */
        .wireshark-panel {
            background: var(--wireshark-bg);
            color: #333;
            display: flex;
            flex-direction: column;
            font-family: var(--font-sans);
            font-size: 0.8rem;
        }

        .ws-toolbar {
            background: #f0f0f0;
            padding: 5px;
            border-bottom: 1px solid #ccc;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .ws-filter-box {
            background: #fff;
            border: 1px solid #ccc;
            padding: 2px 5px;
            width: 300px;
            font-family: var(--font-mono);
            color: #008000;
        }

        .ws-table-container {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th {
            background: var(--ws-header);
            text-align: left;
            padding: 4px;
            border-right: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            font-weight: normal;
            font-size: 0.75rem;
            position: sticky;
            top: 0;
            color: #333;
        }

        td {
            padding: 2px 4px;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        tr.packet-row {
            background-color: var(--ws-udp);
            cursor: pointer;
        }

        tr.packet-row:hover { background-color: #cde1f9; }

        /* --- Control Footer --- */
        footer {
            background: var(--bg-panel);
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .instruction-box {
            flex: 1;
            margin-right: 2rem;
        }
        
        .step-badge {
            display: inline-block;
            background: var(--accent);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .instruction-text {
            font-size: 0.95rem;
            color: var(--text-bright);
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover { filter: brightness(1.1); }
        button:disabled { background: #444; cursor: not-allowed; opacity: 0.7; }

        @media (max-width: 800px) {
            main { grid-template-rows: 50% 50%; }
            .terminals-container { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
            .terminal-window { border-right: none; border-bottom: 1px solid var(--border); }
        }
    </style>
</head>
<body>

<header>
    <h1>UDP Lab Simulator <span class="subtitle">Scenariul 11: Server, Client, Netcat & Wireshark</span></h1>
</header>

<main>
    <!-- Top Half: Terminals -->
    <div class="terminals-container">
        <!-- Terminal 1: Server -->
        <div class="terminal-window" id="termServer">
            <div class="term-header">
                <span>student@lab: ~/udp_project</span>
                <span>Server (UDP)</span>
            </div>
            <div class="term-body" id="termBodyServer">
                <div class="line"><span class="prompt-server">student@lab:$</span> <span class="cursor"></span></div>
            </div>
        </div>

        <!-- Terminal 2: Client -->
        <div class="terminal-window" id="termClient">
            <div class="term-header">
                <span>student@lab: ~</span>
                <span>Client (Netcat/Python)</span>
            </div>
            <div class="term-body" id="termBodyClient">
                <div class="line"><span class="prompt-client">student@lab:$</span> </div>
            </div>
        </div>
    </div>

    <!-- Bottom Half: Wireshark -->
    <div class="wireshark-panel">
        <div class="ws-toolbar">
            <span style="font-weight: bold; color:#0066cc;">Wireshark</span>
            <span style="color:#666;">|</span>
            <span>Filter:</span>
            <input type="text" class="ws-filter-box" value="udp.port == 12345" readonly>
            <span style="flex:1;"></span>
            <span style="font-size:0.75rem; color:#666;">Interface: Loopback: lo0</span>
        </div>
        <div class="ws-table-container">
            <table id="wsTable">
                <thead>
                    <tr>
                        <th style="width: 60px;">No.</th>
                        <th style="width: 90px;">Time</th>
                        <th style="width: 120px;">Source</th>
                        <th style="width: 120px;">Destination</th>
                        <th style="width: 60px;">Proto</th>
                        <th style="width: 60px;">Len</th>
                        <th>Info</th>
                    </tr>
                </thead>
                <tbody id="wsTableBody">
                    <!-- Packets will appear here -->
                </tbody>
            </table>
        </div>
    </div>
</main>

<footer>
    <div class="instruction-box">
        <div class="step-badge" id="stepBadge">Step 1: Start Server</div>
        <div class="instruction-text" id="instructionText">Launch the basic UDP server example. It will listen on all interfaces (0.0.0.0) on port 12345.</div>
    </div>
    <button id="actionBtn" onclick="labManager.next()">Run UDP Server</button>
</footer>

<script>
    // --- Utilities ---
    const wait = (ms) => new Promise(res => setTimeout(res, ms));

    // --- Terminal Logic ---
    class Terminal {
        constructor(elementId, promptClass, promptText) {
            this.body = document.getElementById(elementId);
            this.promptClass = promptClass;
            this.promptText = promptText;
        }

        async typeCommand(cmd) {
            const currentLine = this.body.lastElementChild;
            const cursor = currentLine.querySelector('.cursor');
            if(cursor) cursor.remove();

            const cmdSpan = document.createElement('span');
            cmdSpan.className = 'cmd-text';
            currentLine.appendChild(cmdSpan);

            const newCursor = document.createElement('span');
            newCursor.className = 'cursor';
            currentLine.appendChild(newCursor);

            for (let char of cmd) {
                cmdSpan.innerText += char;
                await wait(Math.random() * 30 + 20);
            }
            
            await wait(100);
            newCursor.remove();
        }

        output(text, className = '') {
            const div = document.createElement('div');
            div.innerText = text;
            div.className = className;
            if(!className) div.style.color = '#ccc';
            this.body.appendChild(div);
            this.scrollToBottom();
        }

        newPrompt(overrideText = null) {
            const div = document.createElement('div');
            div.className = 'line';
            const txt = overrideText !== null ? overrideText : this.promptText;
            div.innerHTML = `<span class="${this.promptClass}">${txt}</span> <span class="cursor"></span>`;
            this.body.appendChild(div);
            this.scrollToBottom();
        }

        scrollToBottom() {
            this.body.scrollTop = this.body.scrollHeight;
        }
        
        clear() {
            this.body.innerHTML = '';
            this.newPrompt();
        }
    }

    // --- Wireshark Logic ---
    class Wireshark {
        constructor() {
            this.tbody = document.getElementById('wsTableBody');
            this.packetCount = 0;
            this.startTime = Date.now();
        }

        addPacket(src, dst, info, len=0) {
            this.packetCount++;
            const timeVal = ((Date.now() - this.startTime) / 1000).toFixed(6);

            const tr = document.createElement('tr');
            tr.className = 'packet-row';
            tr.innerHTML = `
                <td>${this.packetCount}</td>
                <td>${timeVal}</td>
                <td>${src}</td>
                <td>${dst}</td>
                <td>UDP</td>
                <td>${len}</td>
                <td>${info}</td>
            `;
            
            tr.style.animation = "highlight 1s";
            this.tbody.appendChild(tr);
            tr.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
        
        clear() {
            this.tbody.innerHTML = '';
            this.packetCount = 0;
            this.startTime = Date.now();
        }
    }

    // --- Lab Scenario Manager ---
    class LabManager {
        constructor() {
            this.step = 0;
            this.termServer = new Terminal('termBodyServer', 'prompt-server', 'student@lab:$');
            this.termClient = new Terminal('termBodyClient', 'prompt-client', 'student@lab:$');
            this.wireshark = new Wireshark();
            
            this.badge = document.getElementById('stepBadge');
            this.text = document.getElementById('instructionText');
            this.btn = document.getElementById('actionBtn');
        }

        async next() {
            this.btn.disabled = true;

            switch(this.step) {
                case 0: // Step 1: Run Server
                    await this.runServer();
                    break;
                case 1: // Step 2: Netcat Test
                    await this.runNetcat();
                    break;
                case 2: // Step 3: Client Example
                    await this.runClientExample();
                    break;
                case 3: // Step 4: Switch to Templates
                    await this.loadTemplates();
                    break;
                case 4: // Step 5: Test 'ping'
                    await this.testPing();
                    break;
                case 5: // Step 6: Test 'upper'
                    await this.testUpper();
                    break;
                case 6: // Step 7: Final Stats
                    await this.finishLab();
                    break;
            }

            this.btn.disabled = false;
            this.step++;
        }

        // --- Step Implementations ---

        async runServer() {
            this.badge.innerText = "Step 2: Start Server";
            this.text.innerText = "Server is running. Now, switch to the client terminal and use Netcat ('nc -u') to send a raw UDP datagram.";
            
            await this.termServer.typeCommand("python3 S02_Part07_Example_UDP_Server.py 12345");
            this.termServer.output("[INFO] UDP server listening on 0.0.0.0:12345");
            
            this.updateUI("Step 3: Netcat Test", "Use netcat to send 'hello udp'. Observe that UDP is connectionless (no handshake).", "Run Netcat");
        }

        async runNetcat() {
            // Command
            await this.termClient.typeCommand('echo "hello udp" | nc -u 127.0.0.1 12345');
            
            // Wireshark: Request
            this.wireshark.addPacket("59001", "12345", "Data: hello udp", 10);
            
            // Server Log
            this.termServer.output("[INFO] Received 10 bytes from 127.0.0.1:59001");
            this.termServer.output("       Raw message: b'hello udp\\n'");
            this.termServer.output("[INFO] Sent response back to 127.0.0.1:59001");
            
            // Wireshark: Response
            await wait(200);
            this.wireshark.addPacket("12345", "59001", "Data: HELLO UDP", 10);
            
            // Netcat output (often silent in some versions, but let's show it for clarity)
            this.termClient.output("HELLO UDP");
            this.termClient.newPrompt();

            this.updateUI("Step 4: Python Client", "Netcat works, but for better control, we use the Python client script.", "Run Python Client");
        }

        async runClientExample() {
            await this.termClient.typeCommand('python3 S02_Part09_Example_UDP_Client.py 127.0.0.1 12345 "python test"');
            
            this.wireshark.addPacket("59002", "12345", "Data: python test", 11);
            this.termClient.output("[INFO] Sending 11 bytes to 127.0.0.1:12345 ...");
            
            this.termServer.output("[INFO] Received 11 bytes from 127.0.0.1:59002");
            this.termServer.output("       Raw message: b'python test'");
            
            await wait(200);
            this.wireshark.addPacket("12345", "59002", "Data: PYTHON TEST", 11);
            
            this.termClient.output("[INFO] Received 11 bytes from ('127.0.0.1', 12345): b'PYTHON TEST'");
            this.termClient.newPrompt();

            this.updateUI("Step 6: Load Templates", "Great! Now let's simulate that you have modified the code (Server Template & Client Template) to handle 'ping' and 'upper' commands.", "Load Modified Code");
        }

        async loadTemplates() {
            // Clear and Restart Server with Template
            this.termServer.output("^C");
            this.termServer.newPrompt();
            await wait(500);
            
            await this.termServer.typeCommand("python3 S02_Part08_Template_UDP_Server.py 12345");
            this.termServer.output("[INFO] UDP Template Server listening...");
            
            // Start Interactive Client
            await this.termClient.typeCommand("python3 S02_Part10_Template_UDP_Client.py 127.0.0.1 12345");
            this.termClient.output("[INFO] UDP client ready.");
            this.termClient.newPrompt("Message: ");
            
            this.updateUI("Step 7: Test 'ping'", "The interactive client is ready. Type 'ping'. The server should reply 'PONG'.", "Send 'ping'");
        }

        async testPing() {
            await this.termClient.typeCommand("ping");
            
            // Wireshark
            this.wireshark.addPacket("59003", "12345", "Data: ping", 4);
            
            // Server
            this.termServer.output("[CMD] Command: ping | Response: PONG");
            
            await wait(100);
            this.wireshark.addPacket("12345", "59003", "Data: PONG", 4);
            
            // Client
            this.termClient.output("Reply: b'PONG' | RTT: 0.42ms", "log-success");
            this.termClient.newPrompt("Message: ");
            
            this.updateUI("Step 7: Test 'upper'", "Now test the logic: 'upper:hello world'. It should strip 'upper:' and capitalize the rest.", "Send 'upper:...'");
        }

        async testUpper() {
            await this.termClient.typeCommand("upper:hello world");
            
            this.wireshark.addPacket("59003", "12345", "Data: upper:hello world", 17);
            
            this.termServer.output("[CMD] Command: upper | Payload: hello world");
            
            await wait(100);
            this.wireshark.addPacket("12345", "59003", "Data: HELLO WORLD", 11);
            
            this.termClient.output("Reply: b'HELLO WORLD' | RTT: 0.55ms", "log-success");
            this.termClient.newPrompt("Message: ");
            
            this.updateUI("Step 7: Unknown Command", "Try sending a random string like 'random'. The server should return 'UNKNOWN COMMAND'.", "Send 'random'");
        }

        async finishLab() {
            await this.termClient.typeCommand("random");
            this.wireshark.addPacket("59003", "12345", "Data: random", 6);
            this.termServer.output("[CMD] Unknown command: random");
            this.wireshark.addPacket("12345", "59003", "Data: UNKNOWN COMMAND", 15);
            this.termClient.output("Reply: b'UNKNOWN COMMAND' | RTT: 0.38ms");
            
            // Exit
            this.termClient.newPrompt("Message: ");
            await this.termClient.typeCommand("exit");
            this.termClient.output("Sent: 3, Recv: 3, Loss: 0%");
            this.termClient.newPrompt("student@lab:$");

            this.badge.innerText = "Lab Complete";
            this.badge.style.background = "#6a9955";
            this.text.innerText = "Excellent! You've verified the connectionless nature of UDP, the lack of handshakes in Wireshark, and implemented application-layer logic (ping/upper).";
            this.btn.innerText = "Reset Simulation";
            this.btn.onclick = () => location.reload();
        }

        updateUI(badge, text, btnText) {
            this.badge.innerText = badge;
            this.text.innerText = text;
            this.btn.innerText = btnText;
        }
    }

    const labManager = new LabManager();

</script>

</body>
</html>